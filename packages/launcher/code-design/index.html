<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.155.3"><meta name=generator content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862"><meta name=description content="Launcher Module - Code Design Overview The launcher module is the core engine for the Kurel package system, implementing a declarative approach to generating Kubernetes manifests with validation and customization capabilities. This document captures all design decisions made during the architecture planning phase.
Design Philosophy Core Principle: ‚ÄúKurel just generates YAML‚Äù - The launcher is a declarative system for generating Kubernetes manifests, not a runtime system or orchestrator.
Architecture Decisions 1. Core Package Structure Decision: Immutable PackageDefinition with deep copy support"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Code Design :: Go Kure"><meta name=twitter:description content="Launcher Module - Code Design Overview The launcher module is the core engine for the Kurel package system, implementing a declarative approach to generating Kubernetes manifests with validation and customization capabilities. This document captures all design decisions made during the architecture planning phase.
Design Philosophy Core Principle: ‚ÄúKurel just generates YAML‚Äù - The launcher is a declarative system for generating Kubernetes manifests, not a runtime system or orchestrator.
Architecture Decisions 1. Core Package Structure Decision: Immutable PackageDefinition with deep copy support"><meta property="og:url" content="https://www.gokure.dev/packages/launcher/code-design/index.html"><meta property="og:site_name" content="Go Kure"><meta property="og:title" content="Code Design :: Go Kure"><meta property="og:description" content="Launcher Module - Code Design Overview The launcher module is the core engine for the Kurel package system, implementing a declarative approach to generating Kubernetes manifests with validation and customization capabilities. This document captures all design decisions made during the architecture planning phase.
Design Philosophy Core Principle: ‚ÄúKurel just generates YAML‚Äù - The launcher is a declarative system for generating Kubernetes manifests, not a runtime system or orchestrator.
Architecture Decisions 1. Core Package Structure Decision: Immutable PackageDefinition with deep copy support"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Packages"><meta itemprop=name content="Code Design :: Go Kure"><meta itemprop=description content="Launcher Module - Code Design Overview The launcher module is the core engine for the Kurel package system, implementing a declarative approach to generating Kubernetes manifests with validation and customization capabilities. This document captures all design decisions made during the architecture planning phase.
Design Philosophy Core Principle: ‚ÄúKurel just generates YAML‚Äù - The launcher is a declarative system for generating Kubernetes manifests, not a runtime system or orchestrator.
Architecture Decisions 1. Core Package Structure Decision: Immutable PackageDefinition with deep copy support"><meta itemprop=wordCount content="2919"><title>Code Design :: Go Kure</title><link href=/css/auto-complete/auto-complete.min.css?1770889558 rel=stylesheet><script src=/js/auto-complete/auto-complete.min.js?1770889558 defer></script><script src=/js/search-lunr.min.js?1770889558 defer></script><script src=/js/search.min.js?1770889558 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/searchindex.en.js?1770889558"</script><script src=/js/lunr/lunr.min.js?1770889558 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1770889558 defer></script><script src=/js/lunr/lunr.multi.min.js?1770889558 defer></script><script src=/js/lunr/lunr.en.min.js?1770889558 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/fonts/fontawesome/css/fontawesome-all.min.css?1770889558 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/fonts/fontawesome/css/fontawesome-all.min.css?1770889558 rel=stylesheet></noscript><link href=/css/perfect-scrollbar/perfect-scrollbar.min.css?1770889558 rel=stylesheet><link href=/css/theme.min.css?1770889558 rel=stylesheet><link href=/css/format-html.min.css?1770889558 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/packages/launcher/code-design/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://www.gokure.dev",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["relearn-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><div class="notices warning" style=margin-bottom:1rem><div class=label>‚ö†Ô∏è Work in Progress</div><div class=content>Kure is currently under active development and has not been released yet. APIs and features are subject to change.</div></div></head><body class="mobile-support html" data-url=/packages/launcher/code-design/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#design-philosophy>Design Philosophy</a></li><li><a href=#architecture-decisions>Architecture Decisions</a><ul><li><a href=#1-core-package-structure>1. Core Package Structure</a></li><li><a href=#2-interface-organization--common-options>2. Interface Organization & Common Options</a></li><li><a href=#3-package-loading-strategy>3. Package Loading Strategy</a></li><li><a href=#4-variable-resolution>4. Variable Resolution</a></li><li><a href=#5-patch-processing>5. Patch Processing</a></li><li><a href=#6-schema-generation>6. Schema Generation</a></li><li><a href=#7-validation-system>7. Validation System</a></li><li><a href=#8-output-generation>8. Output Generation</a></li><li><a href=#9-local-extensions>9. Local Extensions</a></li><li><a href=#10-cli-integration>10. CLI Integration</a></li></ul></li><li><a href=#module-organization>Module Organization</a></li><li><a href=#error-handling-philosophy>Error Handling Philosophy</a></li><li><a href=#testing-strategy>Testing Strategy</a><ul><li><a href=#individual-component-testability>Individual Component Testability</a></li></ul></li><li><a href=#performance-considerations>Performance Considerations</a></li><li><a href=#security-considerations>Security Considerations</a></li><li><a href=#future-extensibility-points>Future Extensibility Points</a></li><li><a href=#design-constraints>Design Constraints</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Go Kure</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/packages/index.html><span itemprop=name>Packages</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/packages/launcher/index.html><span itemprop=name>Launcher</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Code Design</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/packages/launcher/design-details/index.html title="Design Details (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/packages/launcher/code-implementation-plan/index.html title="Implementation Plan (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable packages" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=code-design>Code Design</h1><h1 id=launcher-module---code-design>Launcher Module - Code Design</h1><h2 id=overview>Overview</h2><p>The launcher module is the core engine for the Kurel package system, implementing a declarative approach to generating Kubernetes manifests with validation and customization capabilities. This document captures all design decisions made during the architecture planning phase.</p><h2 id=design-philosophy>Design Philosophy</h2><p><strong>Core Principle</strong>: &ldquo;Kurel just generates YAML&rdquo; - The launcher is a declarative system for generating Kubernetes manifests, not a runtime system or orchestrator.</p><h2 id=architecture-decisions>Architecture Decisions</h2><h3 id=1-core-package-structure>1. Core Package Structure</h3><p><strong>Decision</strong>: Immutable <code>PackageDefinition</code> with deep copy support</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Immutable package definition with thread-safe access</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageDefinition</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Path</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>    <span style=color:#a6e22e>KurelMetadata</span>     <span style=color:#75715e>// From kurel: key in parameters.yaml</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Parameters</span>  <span style=color:#a6e22e>ParameterMap</span>      <span style=color:#75715e>// Default parameters including global:</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Resources</span>   []<span style=color:#a6e22e>Resource</span>        <span style=color:#75715e>// Base K8s manifests</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Patches</span>     []<span style=color:#a6e22e>Patch</span>          <span style=color:#75715e>// Available patches with metadata</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>      <span style=color:#75715e>// Protect concurrent reads</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DeepCopy creates an independent copy for safe mutation</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>) <span style=color:#a6e22e>DeepCopy</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>PackageDefinition</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Path</span>:       <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>Path</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Metadata</span>:   <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>Metadata</span>, <span style=color:#75715e>// struct copy</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Parameters</span>: <span style=color:#a6e22e>deepCopyMap</span>(<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>Parameters</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Resources</span>:  <span style=color:#a6e22e>deepCopyResources</span>(<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>Resources</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Patches</span>:    <span style=color:#a6e22e>deepCopyPatches</span>(<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>Patches</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Instance with user customization</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageInstance</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Definition</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>  <span style=color:#75715e>// Immutable package reference</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UserValues</span>  <span style=color:#a6e22e>ParameterMap</span>        <span style=color:#75715e>// User-provided overrides</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Resolved</span>    <span style=color:#a6e22e>ParameterMapWithSource</span> <span style=color:#75715e>// Final values with source tracking</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LocalPath</span>   <span style=color:#66d9ef>string</span>              <span style=color:#75715e>// Path to .local.kurel if exists</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Track parameter sources for debugging</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ParameterSource</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>    <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Location</span> <span style=color:#66d9ef>string</span> <span style=color:#75715e>// &#34;package&#34;, &#34;local&#34;, &#34;default&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>File</span>     <span style=color:#66d9ef>string</span> <span style=color:#75715e>// Which file it came from</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Line</span>     <span style=color:#66d9ef>int</span>    <span style=color:#75715e>// Line number if applicable</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ParameterMapWithSource</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>ParameterSource</span></span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Deep copy prevents mutation bugs in concurrent processing</li><li>Source tracking aids debugging</li><li>Thread-safe access for concurrent reads</li><li>Package definitions remain cacheable and reusable</li></ul><h3 id=2-interface-organization--common-options>2. Interface Organization & Common Options</h3><p><strong>Decision</strong>: Small interfaces with centralized LauncherOptions</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// LauncherOptions centralizes common configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LauncherOptions</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span>       <span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxDepth</span>     <span style=color:#66d9ef>int</span>           <span style=color:#75715e>// Variable resolution depth</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#75715e>// Operation timeout</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxWorkers</span>   <span style=color:#66d9ef>int</span>           <span style=color:#75715e>// Concurrent processing</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CacheDir</span>     <span style=color:#66d9ef>string</span>        <span style=color:#75715e>// Schema cache directory</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Debug</span>        <span style=color:#66d9ef>bool</span>          <span style=color:#75715e>// Enable debug output</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Verbose</span>      <span style=color:#66d9ef>bool</span>          <span style=color:#75715e>// Verbose logging</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ProgressFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>)  <span style=color:#75715e>// Progress callback</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DefaultOptions provides sensible defaults</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DefaultOptions</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>LauncherOptions</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LauncherOptions</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Logger</span>:     <span style=color:#a6e22e>NewDefaultLogger</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MaxDepth</span>:   <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timeout</span>:    <span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MaxWorkers</span>: <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NumCPU</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>CacheDir</span>:   <span style=color:#e6db74>&#34;/tmp/kurel-cache&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Debug</span>:      <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Verbose</span>:    <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Decision</strong>: Small, focused interfaces following Go idioms</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// pkg/launcher/interfaces.go - Small, composable interfaces</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DefinitionLoader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LoadDefinition</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LauncherOptions</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ResourceLoader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LoadResources</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Resource</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PatchLoader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LoadPatches</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Patch</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Compose when needed</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageLoader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DefinitionLoader</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ResourceLoader</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PatchLoader</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Resolver</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Resolve</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>overrides</span> <span style=color:#a6e22e>ParameterMap</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LauncherOptions</span>) (<span style=color:#a6e22e>ParameterMapWithSource</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugVariableGraph</span>(<span style=color:#a6e22e>params</span> <span style=color:#a6e22e>ParameterMap</span>) <span style=color:#66d9ef>string</span> <span style=color:#75715e>// Generate dependency graph</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Builder</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>inst</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageInstance</span>, <span style=color:#a6e22e>buildOpts</span> <span style=color:#a6e22e>BuildOptions</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LauncherOptions</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Follows Go&rsquo;s preference for small interfaces (like <code>io.Reader</code>, <code>io.Writer</code>)</li><li>Enables better testing through focused mocks</li><li>Clean separation of contracts from data types</li><li>Supports interface composition</li></ul><h3 id=3-package-loading-strategy>3. Package Loading Strategy</h3><p><strong>Decision</strong>: Hybrid error handling with context support and size limits</p><ul><li><strong>Critical files</strong> (parameters.yaml): Must load successfully or fail immediately</li><li><strong>Other files</strong> (resources, patches): Collect all errors, load what&rsquo;s possible</li><li><strong>Size limits</strong>: Enforce maximum package size (50MB) and resource count (1000)</li><li><strong>Context cancellation</strong>: Support timeout and cancellation</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxPackageSize</span>   = <span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>  <span style=color:#75715e>// 50MB hard limit</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WarnPackageSize</span>  = <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>  <span style=color:#75715e>// 10MB warning</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxResourceCount</span> = <span style=color:#ae81ff>1000</span>               <span style=color:#75715e>// Max resources</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>defaultLoader</span>) <span style=color:#a6e22e>LoadDefinition</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check package size first</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>validatePackageSize</span>(<span style=color:#a6e22e>path</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Critical: parameters.yaml MUST load</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>loadParameters</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;parameters.yaml&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;critical: parameters.yaml: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Best effort for others with context</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errs</span> []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resources</span>, <span style=color:#a6e22e>resourceErrs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>loadAllResources</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>patches</span>, <span style=color:#a6e22e>patchErrs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>loadAllPatches</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>resourceErrs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>patchErrs</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>def</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>PackageDefinition</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Path</span>:       <span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Metadata</span>:   <span style=color:#a6e22e>extractMetadata</span>(<span style=color:#a6e22e>params</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Parameters</span>: <span style=color:#a6e22e>params</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Resources</span>:  <span style=color:#a6e22e>resources</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Patches</span>:    <span style=color:#a6e22e>patches</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>errs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>def</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LoadErrors</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>PartialDefinition</span>: <span style=color:#a6e22e>def</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Issues</span>:           <span style=color:#a6e22e>errs</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>def</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Can&rsquo;t proceed without valid parameters.yaml</li><li>Size limits prevent memory issues (based on typical Helm chart sizes)</li><li>Context support enables cancellation</li><li>See all syntax errors at once for debugging</li></ul><h3 id=4-variable-resolution>4. Variable Resolution</h3><p><strong>Decision</strong>: No inline defaults, configurable depth</p><ul><li>Variables must exist in parameters.yaml (no <code>${var|default}</code> syntax)</li><li>Configurable maximum nesting depth to prevent infinite recursion</li><li>Parameters.yaml is where all defaults are defined</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>variableResolver</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxDepth</span> <span style=color:#66d9ef>int</span>  <span style=color:#75715e>// Configurable, default 10</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Resolution without inline defaults</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ${monitoring.namespace} - ERROR if not defined</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// No fallback syntax supported</span></span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Keeps variable syntax simple</li><li>All defaults in one place (parameters.yaml)</li><li>Prevents infinite recursion while allowing deep nesting</li></ul><h3 id=5-patch-processing>5. Patch Processing</h3><p><strong>Decision</strong>: Strict validation with uniqueness enforcement and debug visualization</p><ul><li><strong>Name uniqueness</strong>: Enforced at load time to prevent confusion</li><li><strong>Conflicts</strong>: Hard error, refuse to continue</li><li><strong>Auto-enable</strong>: Verbose logging to stderr</li><li><strong>Missing targets</strong>: Error, patches must match something</li><li><strong>Application order</strong>: Package patches first (by numeric prefix), then local patches (can override)</li><li><strong>Failure handling</strong>: Patches MUST apply successfully or error - no silent failures</li><li><strong>Debug support</strong>: Patch dependency graph visualization</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Enforce patch name uniqueness at load time</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>defaultLoader</span>) <span style=color:#a6e22e>loadPatches</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Patch</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>patches</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>Patch</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>seen</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) <span style=color:#75715e>// name -&gt; file path</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Walk</span>(<span style=color:#a6e22e>path</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>p</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>FileInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasSuffix</span>(<span style=color:#a6e22e>p</span>, <span style=color:#e6db74>&#34;.kpatch&#34;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>patch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>loadPatch</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Check uniqueness</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>existing</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>seen</span>[<span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;duplicate patch name &#39;%s&#39; in %s and %s&#34;</span>, 
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>existing</span>, <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>seen</span>[<span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>] = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>patches</span> = append(<span style=color:#a6e22e>patches</span>, <span style=color:#a6e22e>patch</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>patches</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Hard error on conflicts</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>hasConflicts</span>(<span style=color:#a6e22e>enabledPatches</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;conflict: %s and %s cannot both be enabled&#34;</span>, <span style=color:#a6e22e>p1</span>, <span style=color:#a6e22e>p2</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Verbose logging during build (--verbose flag)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>INFO</span>: <span style=color:#a6e22e>Enabling</span> <span style=color:#a6e22e>patch</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>-</span><span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>kpatch</span> (<span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>enabled</span>=<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>INFO</span>: <span style=color:#a6e22e>Auto</span><span style=color:#f92672>-</span><span style=color:#a6e22e>enabling</span> <span style=color:#ae81ff>05</span><span style=color:#f92672>-</span><span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>kpatch</span> (<span style=color:#a6e22e>required</span> <span style=color:#a6e22e>by</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>-</span><span style=color:#a6e22e>monitoring</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>DEBUG</span>: <span style=color:#a6e22e>Applying</span> <span style=color:#a6e22e>patch</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>-</span><span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>kpatch</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>deployment</span><span style=color:#f92672>/</span><span style=color:#a6e22e>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DEBUG</span>: <span style=color:#a6e22e>Successfully</span> <span style=color:#a6e22e>patched</span> <span style=color:#a6e22e>field</span> <span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>spec</span>.<span style=color:#a6e22e>containers</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>resources</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Error if patch doesn&#39;t match</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>matchCount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;patch %s targets non-existent resource: deployment.frontend&#34;</span>, <span style=color:#a6e22e>patchName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Patch works on deep copy to preserve immutability</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>patchProcessor</span>) <span style=color:#a6e22e>ApplyPatches</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>def</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>, <span style=color:#a6e22e>patches</span> []<span style=color:#a6e22e>Patch</span>, <span style=color:#a6e22e>params</span> <span style=color:#a6e22e>ParameterMap</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Work on deep copy, never mutate original</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>working</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>def</span>.<span style=color:#a6e22e>DeepCopy</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>patch</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>applyPatch</span>(<span style=color:#a6e22e>working</span>, <span style=color:#a6e22e>patch</span>, <span style=color:#a6e22e>params</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;patch %s failed: %w&#34;</span>, <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>working</span> = <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>working</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Debug visualization for patch dependencies</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>patchProcessor</span>) <span style=color:#a6e22e>DebugPatchGraph</span>(<span style=color:#a6e22e>patches</span> []<span style=color:#a6e22e>Patch</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;digraph patches {\n&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>patch</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patches</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Metadata</span>.<span style=color:#a6e22e>Requires</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;  \&#34;%s\&#34; -&gt; \&#34;%s\&#34;;\n&#34;</span>, <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>req</span>))
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>conflict</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Metadata</span>.<span style=color:#a6e22e>Conflicts</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;  \&#34;%s\&#34; -&gt; \&#34;%s\&#34; [color=red,style=dashed];\n&#34;</span>, 
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>conflict</span>))
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;}\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Immutability prevents subtle bugs</li><li>Name uniqueness prevents configuration errors</li><li>Debug visualization aids troubleshooting</li><li>Clear visibility into auto-enabled dependencies</li><li>No silent failures</li></ul><h3 id=6-schema-generation>6. Schema Generation</h3><p><strong>Decision</strong>: Hybrid approach with memoization and type validation</p><ul><li>Bundle schemas for resources known in internal/ packages</li><li>Package maintainers can specify CRD schema URLs in parameters.yaml</li><li>Auto-generate if missing, allow explicit regeneration</li><li>Memoize path tracing for performance</li><li>Validate type consistency across patches</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># In parameters.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kurel</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>schemas</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>https://raw.githubusercontent.com/cert-manager/cert-manager/v1.13.0/deploy/crds/crd-certificates.yaml</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.68.0/deploy/crds/crd-prometheuses.yaml</span></span></span></code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Memoized path tracer for performance</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>memoizedPathTracer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>TraceResult</span> <span style=color:#75715e>// path:variable ‚Üí schema mapping</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>memoizedPathTracer</span>) <span style=color:#a6e22e>TracePath</span>(<span style=color:#a6e22e>patchPath</span>, <span style=color:#a6e22e>variable</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>TraceResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%s&#34;</span>, <span style=color:#a6e22e>patchPath</span>, <span style=color:#a6e22e>variable</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Compute if not cached</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>doTrace</span>(<span style=color:#a6e22e>patchPath</span>, <span style=color:#a6e22e>variable</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Validate type consistency across patches</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SchemaGenerator</span>) <span style=color:#a6e22e>ValidateSchemaMerge</span>(<span style=color:#a6e22e>patches</span> []<span style=color:#a6e22e>Patch</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>typeMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) <span style=color:#75715e>// variable ‚Üí expected type</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>patch</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>traces</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>TraceAll</span>(<span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Content</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>variable</span>, <span style=color:#a6e22e>trace</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>traces</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expectedType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Schema</span>.<span style=color:#a6e22e>Type</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>existing</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>typeMap</span>[<span style=color:#a6e22e>variable</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>existing</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>expectedType</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;type conflict for %s: patch %s expects %s, but %s expected&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>variable</span>, <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>expectedType</span>, <span style=color:#a6e22e>existing</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>typeMap</span>[<span style=color:#a6e22e>variable</span>] = <span style=color:#a6e22e>expectedType</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Memoization improves performance for repeated operations</li><li>Type validation prevents schema conflicts</li><li>Leverages existing Kure knowledge</li><li>Extensible for custom CRDs</li></ul><h3 id=7-validation-system>7. Validation System</h3><p><strong>Decision</strong>: Errors block, warnings don&rsquo;t; concurrent validation for performance</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ValidationResult</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Errors</span>   []<span style=color:#a6e22e>ValidationError</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Warnings</span> []<span style=color:#a6e22e>ValidationWarning</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ConcurrentValidator</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxWorkers</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>schemaGen</span>  <span style=color:#a6e22e>SchemaGenerator</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConcurrentValidator</span>) <span style=color:#a6e22e>ValidateInstance</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>inst</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageInstance</span>) <span style=color:#a6e22e>ValidationResult</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate resources concurrently for performance</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>numWorkers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NumCPU</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>Definition</span>.<span style=color:#a6e22e>Resources</span>) &lt; <span style=color:#a6e22e>numWorkers</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>numWorkers</span> = len(<span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>Definition</span>.<span style=color:#a6e22e>Resources</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>work</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>Resource</span>, len(<span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>Definition</span>.<span style=color:#a6e22e>Resources</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ValidationError</span>, len(<span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>Definition</span>.<span style=color:#a6e22e>Resources</span>))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start workers</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>numWorkers</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>work</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>validateResource</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>resource</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ValidationError</span>{<span style=color:#a6e22e>Resource</span>: <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>GetName</span>(), <span style=color:#a6e22e>Error</span>: <span style=color:#a6e22e>err</span>}
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Queue work</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>Definition</span>.<span style=color:#a6e22e>Resources</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>work</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    close(<span style=color:#a6e22e>work</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Collect results</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>        close(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>ValidationResult</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>results</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Errors</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Errors</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Concurrent validation for Helm-like performance</li><li>Clear distinction between blocking and non-blocking issues</li><li>Best-effort validation based on available information</li><li>Worker pool pattern prevents resource exhaustion</li></ul><h3 id=8-output-generation>8. Output Generation</h3><p><strong>Decision</strong>: No GitOps-specific support, configurable output format</p><ul><li>Kurel only manages <code>kurel.gokure.dev/</code> annotations for phase organization</li><li>Actual deployment handled by GitOps tools (Flux/ArgoCD)</li><li>Configurable output: stdout (default/dry-run), single file, by-kind, by-resource</li><li>Multi-document YAML files are properly handled</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Default: multi-doc YAML to stdout (dry-run mode)</span>
</span></span><span style=display:flex><span>kurel build my-app.kurel/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Output to directory with by-kind grouping</span>
</span></span><span style=display:flex><span>kurel build my-app.kurel/ -o out/ --format<span style=color:#f92672>=</span>by-kind
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Single file output</span>
</span></span><span style=display:flex><span>kurel build my-app.kurel/ -o manifests.yaml --format<span style=color:#f92672>=</span>single
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># JSON output</span>
</span></span><span style=display:flex><span>kurel build my-app.kurel/ --output-format<span style=color:#f92672>=</span>json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Verbose mode for debugging</span>
</span></span><span style=display:flex><span>kurel build my-app.kurel/ --verbose</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Keeps kurel focused on YAML generation only</li><li>Default stdout output serves as dry-run mode</li><li>Flexible output for different workflows</li><li>Clean separation of concerns</li><li>Verbose mode aids in debugging patch application</li></ul><h3 id=9-local-extensions>9. Local Extensions</h3><p><strong>Decision</strong>: Full integration with validation</p><ul><li>Local patches CAN reference package patches in dependencies</li><li>Parameter conflicts are validated for compatibility</li><li>Local extensions can only add, not replace</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># my-app.local.kurel/patches/50-custom.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>requires</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;features/10-monitoring.kpatch&#34;</span>  <span style=color:#75715e># Can reference package patches</span>
</span></span><span style=display:flex><span><span style=color:#f92672>conflicts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;features/20-basic-monitoring.kpatch&#34;</span>  <span style=color:#75715e># Can conflict with package</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Parameter override validation</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Error if local changes parameter type/structure incompatibly</span></span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Allows sophisticated customization</li><li>Prevents breaking changes</li><li>Maintains package integrity</li></ul><h3 id=10-cli-integration>10. CLI Integration</h3><p><strong>Decision</strong>: YAML to stdout, logs to stderr, with timeout and progress indication</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DefaultBuildTimeout</span> = <span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>  <span style=color:#75715e>// Similar to Helm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxBuildTimeout</span>     = <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>buildOptions</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>valuesFile</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>outputPath</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>outputFormat</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>outputType</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>localPath</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>verbose</span>      <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dryRun</span>       <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>quiet</span>        <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>showProgress</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Build command with proper flag handling</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newBuildCommand</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>buildOptions</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Use</span>:   <span style=color:#e6db74>&#34;build &lt;package&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Short</span>: <span style=color:#e6db74>&#34;Build Kubernetes manifests from kurel package&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RunE</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>, <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Apply timeout</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Progress indication for long operations</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>progress</span> <span style=color:#a6e22e>ProgressReporter</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>showProgress</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>quiet</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>progress</span> = <span style=color:#a6e22e>NewProgressBar</span>(<span style=color:#e6db74>&#34;Building package...&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>progress</span>.<span style=color:#a6e22e>Finish</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>runBuild</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>progress</span>)
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Flags</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>StringVarP</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>valuesFile</span>, <span style=color:#e6db74>&#34;values&#34;</span>, <span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;Values file&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>StringVarP</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>outputPath</span>, <span style=color:#e6db74>&#34;output&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;Output path (default: stdout)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>DurationVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>timeout</span>, <span style=color:#e6db74>&#34;timeout&#34;</span>, <span style=color:#a6e22e>DefaultBuildTimeout</span>, <span style=color:#e6db74>&#34;Build timeout&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>BoolVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>dryRun</span>, <span style=color:#e6db74>&#34;dry-run&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;Print to stdout without writing&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>BoolVarP</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>verbose</span>, <span style=color:#e6db74>&#34;verbose&#34;</span>, <span style=color:#e6db74>&#34;v&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;Verbose output&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flags</span>.<span style=color:#a6e22e>BoolVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>showProgress</span>, <span style=color:#e6db74>&#34;progress&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;Show progress bar&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Rationale</strong>:</p><ul><li>Timeout prevents hanging builds</li><li>Progress indication for better UX</li><li>Unix philosophy: stdout for data, stderr for logs</li><li>Matches Helm&rsquo;s performance characteristics</li></ul><h2 id=module-organization>Module Organization</h2><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>pkg/launcher/
‚îú‚îÄ‚îÄ interfaces.go       # All public interfaces
‚îú‚îÄ‚îÄ types.go           # Core data types with deep copy
‚îú‚îÄ‚îÄ options.go         # LauncherOptions and configuration
‚îú‚îÄ‚îÄ loader.go          # Package loading with uniqueness checks
‚îú‚îÄ‚îÄ variables.go       # Variable resolution with source tracking
‚îú‚îÄ‚îÄ patches.go         # Patch processing with immutability
‚îú‚îÄ‚îÄ schema.go          # Schema generation with memoization
‚îú‚îÄ‚îÄ validator.go       # Validation logic
‚îú‚îÄ‚îÄ builder.go         # Manifest building and output
‚îú‚îÄ‚îÄ extensions.go      # Local extension handling
‚îú‚îÄ‚îÄ errors.go          # Custom error types
‚îú‚îÄ‚îÄ debug.go           # Debug visualization (graphs, etc.)
‚îú‚îÄ‚îÄ deepcopy.go        # Deep copy utilities
‚îî‚îÄ‚îÄ testdata/         # Test fixtures
    ‚îú‚îÄ‚îÄ packages/     # Sample packages for testing
    ‚îî‚îÄ‚îÄ mocks/        # Mock implementations for testing</code></pre></div><h2 id=error-handling-philosophy>Error Handling Philosophy</h2><ol><li><strong>Fail fast</strong> for critical errors (missing parameters.yaml)</li><li><strong>Abort all</strong> on patch failures (transactional behavior)</li><li><strong>Use existing error patterns</strong> from pkg/errors</li><li><strong>Clear error messages</strong> with context and suggestions</li><li><strong>Distinguish</strong> between errors (blocking) and warnings (advisory)</li><li><strong>Context cancellation</strong> respected throughout</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Leverage existing Kure error patterns</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LoadErrors</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>BaseError</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PartialDefinition</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageDefinition</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Issues</span>            []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LoadErrors</span>) <span style=color:#a6e22e>Unwrap</span>() []<span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Issues</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Transactional patch application</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>patchProcessor</span>) <span style=color:#a6e22e>ApplyPatches</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>resources</span> []<span style=color:#a6e22e>Resource</span>, <span style=color:#a6e22e>patches</span> []<span style=color:#a6e22e>Patch</span>) ([]<span style=color:#a6e22e>Resource</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Work on copy for rollback capability</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>working</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>Resource</span>, len(<span style=color:#a6e22e>resources</span>))
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>working</span>, <span style=color:#a6e22e>resources</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>patch</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>patches</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cancelled at patch %d/%d: %w&#34;</span>, <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, len(<span style=color:#a6e22e>patches</span>), <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>applyPatch</span>(<span style=color:#a6e22e>working</span>, <span style=color:#a6e22e>patch</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Fail fast - abort all</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;patch %s failed (aborting all): %w&#34;</span>, <span style=color:#a6e22e>patch</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>working</span> = <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>working</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=testing-strategy>Testing Strategy</h2><ul><li><strong>Table-driven tests</strong>: Following Go best practices with subtests</li><li><strong>Individual component tests</strong>: Each component independently testable</li><li><strong>Benchmarks</strong>: Ensure performance matches Helm</li><li><strong>Mock filesystem</strong>: Using afero for loader testing</li><li><strong>Integration tests</strong>: Full package processing flows</li><li><strong>Fixture packages</strong>: Real-world package examples in testdata/</li><li><strong>Concurrent testing</strong>: Validate thread safety</li></ul><h3 id=individual-component-testability>Individual Component Testability</h3><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Test resolver independently</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestResolverIndependent</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LauncherOptions</span>{<span style=color:#a6e22e>MaxDepth</span>: <span style=color:#ae81ff>5</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolver</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewResolver</span>(<span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ParameterMap</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app&#34;</span>: <span style=color:#e6db74>&#34;myapp&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;v1.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;image&#34;</span>: <span style=color:#e6db74>&#34;${app}:${tag}&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolved</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>Resolve</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>params</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;myapp:v1.0&#34;</span>, <span style=color:#a6e22e>resolved</span>[<span style=color:#e6db74>&#34;image&#34;</span>].<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Test patch processor independently</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestPatchProcessorIndependent</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DefaultOptions</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>processor</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewPatchProcessor</span>(<span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Mock resources</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>def</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>PackageDefinition</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Resources</span>: []<span style=color:#a6e22e>Resource</span>{
</span></span><span style=display:flex><span>            {<span style=color:#a6e22e>Kind</span>: <span style=color:#e6db74>&#34;Deployment&#34;</span>, <span style=color:#a6e22e>Metadata</span>: <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>ObjectMeta</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;app&#34;</span>}},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>patch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Patch</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:    <span style=color:#e6db74>&#34;scale&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Content</span>: <span style=color:#e6db74>&#34;[deployment.app]\nspec.replicas: 3&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>ApplyPatches</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>def</span>, []<span style=color:#a6e22e>Patch</span>{<span style=color:#a6e22e>patch</span>}, <span style=color:#a6e22e>ParameterMap</span>{})
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NotEqual</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>def</span>, <span style=color:#a6e22e>result</span>) <span style=color:#75715e>// Ensure deep copy</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Test validator independently with mock schema</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestValidatorIndependent</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mockSchema</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>MockSchemaGenerator</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>schema</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Schema</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Properties</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>SchemaProperty</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;replicas&#34;</span>: {<span style=color:#a6e22e>Type</span>: <span style=color:#e6db74>&#34;integer&#34;</span>, <span style=color:#a6e22e>Minimum</span>: <span style=color:#ae81ff>1</span>},
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DefaultOptions</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>validator</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewValidator</span>(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>WithSchemaGenerator</span>(<span style=color:#a6e22e>mockSchema</span>))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ParameterMap</span>{<span style=color:#e6db74>&#34;replicas&#34;</span>: <span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>validator</span>.<span style=color:#a6e22e>ValidateParameters</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>params</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Errors</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Errors</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Error</span>(), <span style=color:#e6db74>&#34;below minimum&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Table-driven test example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestVariableResolver</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>base</span>      <span style=color:#a6e22e>ParameterMap</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>overrides</span> <span style=color:#a6e22e>ParameterMap</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>want</span>      <span style=color:#a6e22e>ParameterMap</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wantErr</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    }{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;simple_substitution&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>base</span>: <span style=color:#a6e22e>ParameterMap</span>{<span style=color:#e6db74>&#34;app&#34;</span>: <span style=color:#e6db74>&#34;myapp&#34;</span>, <span style=color:#e6db74>&#34;image&#34;</span>: <span style=color:#e6db74>&#34;${app}:latest&#34;</span>},
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>want</span>: <span style=color:#a6e22e>ParameterMap</span>{<span style=color:#e6db74>&#34;app&#34;</span>: <span style=color:#e6db74>&#34;myapp&#34;</span>, <span style=color:#e6db74>&#34;image&#34;</span>: <span style=color:#e6db74>&#34;myapp:latest&#34;</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>name</span>:    <span style=color:#e6db74>&#34;circular_dependency&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>base</span>:    <span style=color:#a6e22e>ParameterMap</span>{<span style=color:#e6db74>&#34;a&#34;</span>: <span style=color:#e6db74>&#34;${b}&#34;</span>, <span style=color:#e6db74>&#34;b&#34;</span>: <span style=color:#e6db74>&#34;${a}&#34;</span>},
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wantErr</span>: <span style=color:#e6db74>&#34;circular dependency&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>resolver</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewResolver</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>got</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>Resolve</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>overrides</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantErr</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantErr</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Benchmark example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkBuildPackage</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>packages</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resources</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>target</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    }{
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;small&#34;</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>},
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;medium&#34;</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>},
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>&#34;large&#34;</span>, <span style=color:#ae81ff>200</span>, <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>packages</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>pkg</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>generateTestPackage</span>(<span style=color:#a6e22e>pkg</span>.<span style=color:#a6e22e>resources</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>BuildOptions</span>{})
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=performance-considerations>Performance Considerations</h2><ol><li><strong>Concurrent processing</strong>: Use worker pools for CPU-intensive operations</li><li><strong>Memory limits</strong>: Enforce package size limits (50MB max, 10MB warning)</li><li><strong>Streaming</strong>: Stream large resource sets to avoid memory spikes</li><li><strong>Caching</strong>: Cache schemas with TTL for repeated operations</li><li><strong>Context cancellation</strong>: Support timeouts and early termination</li><li><strong>Performance targets</strong> (matching Helm):<ul><li>Small packages (1-20 resources): &lt; 100ms</li><li>Medium packages (21-100 resources): &lt; 500ms</li><li>Large packages (101-500 resources): &lt; 2s</li><li>X-Large packages (500+ resources): &lt; 5s</li></ul></li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Concurrent validation with worker pool</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Validator</span>) <span style=color:#a6e22e>ValidateConcurrent</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>resources</span> []<span style=color:#a6e22e>Resource</span>) []<span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>workers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NumCPU</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>resources</span>) &lt; <span style=color:#a6e22e>workers</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>workers</span> = len(<span style=color:#a6e22e>resources</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sem</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#a6e22e>workers</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, len(<span style=color:#a6e22e>resources</span>))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>resources</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>resource</span> <span style=color:#a6e22e>Resource</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>sem</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sem</span> }()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>resource</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>        close(<span style=color:#a6e22e>errChan</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errors</span> []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>errChan</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errors</span> = append(<span style=color:#a6e22e>errors</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=security-considerations>Security Considerations</h2><ol><li><strong>Path traversal protection</strong> in package loading</li><li><strong>URL validation</strong> for schema URLs</li><li><strong>Variable injection prevention</strong> in resolution</li><li><strong>Resource validation</strong> against schemas</li><li><strong>No direct secret creation</strong> - only references via external-secrets or similar patterns</li><li><strong>Sensitive data handling</strong> - parameters may contain references but not actual secrets</li></ol><h2 id=future-extensibility-points>Future Extensibility Points</h2><ol><li><strong>Plugin system</strong> for custom validators (future consideration)</li><li><strong>Remote package loading</strong> (git, https)</li><li><strong>Package signing</strong> and verification</li><li><strong>Advanced patch operations</strong> (JSONPatch, strategic merge)</li><li><strong>Dependency resolution</strong> between packages</li><li><strong>Observability and metrics</strong> (future consideration)</li><li><strong>Schema merging validation</strong> - Detect type mismatches when patches imply incompatible schemas</li><li><strong>Interactive debug mode</strong> - Step through patch application</li><li><strong>Package composition</strong> - Combine multiple packages safely</li></ol><h2 id=design-constraints>Design Constraints</h2><ul><li>No templating engines (use patches)</li><li>No runtime operations (just generate YAML)</li><li>No cluster connectivity required</li><li>No package registry dependency</li><li>Deterministic output (same input = same output)</li><li>No direct secret creation (use external references)</li><li>Patches must succeed or error (no silent failures)</li><li>Local patches can override package patches</li></ul><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a href=https://www.gokure.dev/ style=text-decoration:none><h1 style=margin:0;padding:1rem;color:var(--MENU-SECTIONS-ACTIVE-BG-color)>Go Kure</h1></a><div style="padding:0 1rem 1rem"><div style="background-color:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:4px;padding:.75rem"><div style=display:flex;align-items:center;font-weight:700;color:#ffc107;margin-bottom:.25rem;font-size:.9rem><span style=margin-right:.5rem>‚ö†Ô∏è</span>
<span>Pre-Release</span></div><div style=font-size:.8rem;color:#ffeb3b;line-height:1.3>Unreleased software - APIs subject to change</div></div></div></div><search><form action=/search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search></div><div id=R-homelinks class="default-animation homelinks"><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-homelinks"><ul class="space collapsible-menu"><li data-nav-id=/index.html><a class=padding href=/index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-headercontrols"><ul></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div></div><div id=R-content-wrapper class=highlightable><div class="R-sidebarmenu R-shortcutmenu-main"><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/overview/index.html><a class=padding href=/overview/index.html>Overview</a><ul id=R-subsections-0545e563276d3ac6e3218cfecf67a14b class=collapsible-menu></ul></li><li data-nav-id=/getting-started/index.html><a class=padding href=/getting-started/index.html>Getting Started</a><ul id=R-subsections-87c0363912f379e0725cbe1d504c985c class=collapsible-menu></ul></li><li data-nav-id=/architecture/index.html><a class=padding href=/architecture/index.html>Architecture</a><ul id=R-subsections-9e2fbae00589891720aedcdff0084e07 class=collapsible-menu></ul></li><li class=parent data-nav-id=/packages/index.html><a class=padding href=/packages/index.html>Packages</a><ul id=R-subsections-bdf1e8ce92aa8ff6883c617f10480430 class=collapsible-menu><li class="parent alwaysopen" data-nav-id=/packages/launcher/index.html><a class=padding href=/packages/launcher/index.html>Launcher</a><ul id=R-subsections-9d3dfa62b00c459cf937434644ffeb15 class=collapsible-menu><li data-nav-id=/packages/launcher/readme/index.html><a class=padding href=/packages/launcher/readme/index.html>Overview</a></li><li data-nav-id=/packages/launcher/design/index.html><a class=padding href=/packages/launcher/design/index.html>Design</a></li><li data-nav-id=/packages/launcher/design-details/index.html><a class=padding href=/packages/launcher/design-details/index.html>Design Details</a></li><li class=active data-nav-id=/packages/launcher/code-design/index.html><a class=padding href=/packages/launcher/code-design/index.html>Code Design</a></li><li data-nav-id=/packages/launcher/code-implementation-plan/index.html><a class=padding href=/packages/launcher/code-implementation-plan/index.html>Implementation Plan</a></li><li data-nav-id=/packages/launcher/architecture/index.html><a class=padding href=/packages/launcher/architecture/index.html>Architecture</a></li></ul></li><li class=alwaysopen data-nav-id=/packages/patch/index.html><a class=padding href=/packages/patch/index.html>Patch</a><ul id=R-subsections-7c547ca0c10cfe9e866a079fe02bd5a8 class=collapsible-menu></ul></li><li class=alwaysopen data-nav-id=/packages/stack/index.html><a class=padding href=/packages/stack/index.html>Stack</a><ul id=R-subsections-02bd8df3d763850187342f84e596fe01 class=collapsible-menu></ul></li><li class=alwaysopen data-nav-id=/packages/layout/index.html><a class=padding href=/packages/layout/index.html>Layout</a><ul id=R-subsections-77c3a0c7a55ddc3d5c690813bfe4621c class=collapsible-menu></ul></li><li data-nav-id=/packages/io/index.html><a class=padding href=/packages/io/index.html>IO</a></li><li data-nav-id=/packages/errors/index.html><a class=padding href=/packages/errors/index.html>Errors</a></li><li data-nav-id=/packages/cli/index.html><a class=padding href=/packages/cli/index.html>CLI</a></li></ul></li><li data-nav-id=/examples/index.html><a class=padding href=/examples/index.html>Examples</a><ul id=R-subsections-2e4187ca04853a7e1382c8d86f7be6fd class=collapsible-menu></ul></li><li data-nav-id=/reference/index.html><a class=padding href=/reference/index.html>Reference</a><ul id=R-subsections-66002f201bef818664bb81aa67490c58 class=collapsible-menu></ul></li><li data-nav-id=/development/index.html><a class=padding href=/development/index.html>Development</a><ul id=R-subsections-54b0ce3c97b111c8cd4d107325fd580c class=collapsible-menu></ul></li><li data-nav-id=/changelog/index.html><a class=padding href=/changelog/index.html>Changelog</a><ul id=R-subsections-d1977150cf385e06b32490e43a8e612b class=collapsible-menu></ul></li></ul></div><div class="R-sidebarmenu R-shortcutmenu-shortcuts"><ul class="space collapsible-menu"></ul></div><div id=R-footer-margin></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-footercontrols"><ul></ul></div><div id=R-footer><div style="position:sticky;bottom:0;padding:1rem;margin-top:2rem;background-color:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-top:3px solid #ffc107"><div style=display:flex;align-items:center;font-weight:700;color:#ffc107;margin-bottom:.5rem><span style=margin-right:.5rem>‚ö†Ô∏è</span>
<span>Pre-Release Software</span></div><div style=font-size:.875rem;color:#ffeb3b;line-height:1.4>This documentation is for unreleased software. Features and APIs may change before the official release.</div></div></div></div></aside><script src=/js/clipboard/clipboard.min.js?1770889558 defer></script><script src=/js/perfect-scrollbar/perfect-scrollbar.min.js?1770889558 defer></script><script src=/js/theme.min.js?1770889558 defer></script></body></html>