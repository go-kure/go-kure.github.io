<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="Kurel Package System - Comprehensive Design Details This document captures the complete design discussion, decisions, alternatives considered, and rationale for the Kurel (Kubernetes Resources Launcher) package system. It serves as a comprehensive record of all design choices made during the extensive design iteration process.
Design Philosophy &amp; Core Principles Fundamental Philosophy â€œKurel just generates YAMLâ€ - This principle guided every design decision. Kurel is not a runtime system, orchestrator, or complex package manager. Itâ€™s a declarative system for generating Kubernetes manifests with validation and customization capabilities.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="Kurel Package System - Comprehensive Design Details This document captures the complete design discussion, decisions, alternatives considered, and rationale for the Kurel (Kubernetes Resources Launcher) package system. It serves as a comprehensive record of all design choices made during the extensive design iteration process.
Design Philosophy &amp; Core Principles Fundamental Philosophy â€œKurel just generates YAMLâ€ - This principle guided every design decision. Kurel is not a runtime system, orchestrator, or complex package manager. Itâ€™s a declarative system for generating Kubernetes manifests with validation and customization capabilities.">
    <meta property="og:url" content="http://localhost:1313/packages/launcher/design-details/index.html">
    <meta property="og:site_name" content="Go Kure">
    <meta property="og:description" content="Kurel Package System - Comprehensive Design Details This document captures the complete design discussion, decisions, alternatives considered, and rationale for the Kurel (Kubernetes Resources Launcher) package system. It serves as a comprehensive record of all design choices made during the extensive design iteration process.
Design Philosophy &amp; Core Principles Fundamental Philosophy â€œKurel just generates YAMLâ€ - This principle guided every design decision. Kurel is not a runtime system, orchestrator, or complex package manager. Itâ€™s a declarative system for generating Kubernetes manifests with validation and customization capabilities.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Packages">
    <meta itemprop="description" content="Kurel Package System - Comprehensive Design Details This document captures the complete design discussion, decisions, alternatives considered, and rationale for the Kurel (Kubernetes Resources Launcher) package system. It serves as a comprehensive record of all design choices made during the extensive design iteration process.
Design Philosophy &amp; Core Principles Fundamental Philosophy â€œKurel just generates YAMLâ€ - This principle guided every design decision. Kurel is not a runtime system, orchestrator, or complex package manager. Itâ€™s a declarative system for generating Kubernetes manifests with validation and customization capabilities.">
    <meta itemprop="wordCount" content="3947">
    <title></title>
    <link href="/css/auto-complete/auto-complete.min.css?1754413039" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1754413039" defer></script>
    <script src="/js/search-lunr.js?1754413039" defer></script>
    <script src="/js/search.js?1754413039" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1754413039";
    </script>
    <script src="/js/lunr/lunr.min.js?1754413039" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1754413039" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1754413039" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1754413039" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1754413039" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1754413039" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1754413039" rel="stylesheet">
    <link href="/css/theme.css?1754413039" rel="stylesheet">
    <link href="/css/format-html.css?1754413039" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/packages\/launcher\/design-details\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'relearn-dark' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><div class="notices warning" style="margin-bottom: 1rem;">
    <div class="label">âš ï¸ Work in Progress</div>
    <div class="content">Kure is currently under active development and has not been released yet. APIs and features are subject to change.</div>
</div>
  </head>
  <body class="mobile-support html" data-url="/packages/launcher/design-details/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#design-philosophy--core-principles">Design Philosophy &amp; Core Principles</a>
      <ul>
        <li><a href="#fundamental-philosophy">Fundamental Philosophy</a></li>
        <li><a href="#core-design-principles">Core Design Principles</a></li>
        <li><a href="#key-design-constraints">Key Design Constraints</a></li>
      </ul>
    </li>
    <li><a href="#research-insights-from-existing-systems">Research Insights from Existing Systems</a>
      <ul>
        <li><a href="#helm-charts-analysis">Helm Charts Analysis</a></li>
        <li><a href="#docker-compose-learnings">Docker Compose Learnings</a></li>
        <li><a href="#terraform-modules-study">Terraform Modules Study</a></li>
        <li><a href="#kustomize-patterns">Kustomize Patterns</a></li>
        <li><a href="#argocd-applications-research">ArgoCD Applications Research</a></li>
        <li><a href="#key-research-conclusions">Key Research Conclusions</a></li>
      </ul>
    </li>
    <li><a href="#package-structure-evolution">Package Structure Evolution</a>
      <ul>
        <li><a href="#final-package-structure">Final Package Structure</a></li>
        <li><a href="#original-structure-rejected">Original Structure (Rejected)</a></li>
        <li><a href="#evolution--rejected-alternatives">Evolution &amp; Rejected Alternatives</a></li>
      </ul>
    </li>
    <li><a href="#parameters-system-design">Parameters System Design</a>
      <ul>
        <li><a href="#final-parameter-structure">Final Parameter Structure</a></li>
        <li><a href="#variable-reference-system">Variable Reference System</a></li>
        <li><a href="#fixed-top-level-keys">Fixed Top-Level Keys</a></li>
        <li><a href="#extendedvalue-evolution">ExtendedValue Evolution</a></li>
        <li><a href="#parameter-override-system">Parameter Override System</a></li>
      </ul>
    </li>
    <li><a href="#patch-system-architecture">Patch System Architecture</a>
      <ul>
        <li><a href="#patch-discovery--organization">Patch Discovery &amp; Organization</a></li>
        <li><a href="#patch-discovery--ordering">Patch Discovery &amp; Ordering</a></li>
        <li><a href="#conditional-patch-enabling">Conditional Patch Enabling</a></li>
        <li><a href="#base-patch-pattern">Base Patch Pattern</a></li>
        <li><a href="#toml-headers-clarification">TOML Headers Clarification</a></li>
      </ul>
    </li>
    <li><a href="#multi-namespace-support--validation">Multi-Namespace Support &amp; Validation</a>
      <ul>
        <li><a href="#namespace-handling-philosophy">Namespace Handling Philosophy</a></li>
        <li><a href="#namespace-creation-control">Namespace Creation Control</a></li>
        <li><a href="#validation-scope--approach">Validation Scope &amp; Approach</a></li>
      </ul>
    </li>
    <li><a href="#gitops-integration--deployment-phases">GitOps Integration &amp; Deployment Phases</a>
      <ul>
        <li><a href="#install-phase-annotations">Install Phase Annotations</a></li>
        <li><a href="#flux-translation-example">Flux Translation Example</a></li>
        <li><a href="#argocd-compatibility">ArgoCD Compatibility</a></li>
        <li><a href="#patch-modification-of-phases">Patch Modification of Phases</a></li>
      </ul>
    </li>
    <li><a href="#user-extension-system">User Extension System</a>
      <ul>
        <li><a href="#localkurel-design-pattern">.local.kurel Design Pattern</a></li>
        <li><a href="#rejected-extension-patterns">Rejected Extension Patterns</a></li>
      </ul>
    </li>
    <li><a href="#schema-generation--validation">Schema Generation &amp; Validation</a>
      <ul>
        <li><a href="#schema-generation-approach">Schema Generation Approach</a></li>
        <li><a href="#validation-command-design">Validation Command Design</a></li>
        <li><a href="#crd-support-strategy">CRD Support Strategy</a></li>
        <li><a href="#schema-distribution">Schema Distribution</a></li>
      </ul>
    </li>
    <li><a href="#rejected-features--design-alternatives">Rejected Features &amp; Design Alternatives</a>
      <ul>
        <li><a href="#package-dependencies">Package Dependencies</a></li>
        <li><a href="#rbac-auto-management">RBAC Auto-Management</a></li>
        <li><a href="#multi-tenancy-enforcement">Multi-Tenancy Enforcement</a></li>
        <li><a href="#complex-expression-language">Complex Expression Language</a></li>
        <li><a href="#conditional-yaml-structures">Conditional YAML Structures</a></li>
        <li><a href="#pre-generated-schemas-in-packages">Pre-Generated Schemas in Packages</a></li>
        <li><a href="#complex-package-composition">Complex Package Composition</a></li>
      </ul>
    </li>
    <li><a href="#implementation-considerations">Implementation Considerations</a>
      <ul>
        <li><a href="#cli-command-design">CLI Command Design</a></li>
        <li><a href="#variable-resolution-engine">Variable Resolution Engine</a></li>
        <li><a href="#patch-processing-engine">Patch Processing Engine</a></li>
        <li><a href="#gitops-manifest-generation">GitOps Manifest Generation</a></li>
      </ul>
    </li>
    <li><a href="#future-considerations">Future Considerations</a>
      <ul>
        <li><a href="#schema-generation-improvements">Schema Generation Improvements</a></li>
        <li><a href="#package-ecosystem">Package Ecosystem</a></li>
        <li><a href="#advanced-patch-features">Advanced Patch Features</a></li>
        <li><a href="#developer-experience">Developer Experience</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Go Kure</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/packages/index.html"><span itemprop="name">Packages</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/packages/launcher/index.html" title="(ğŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/examples/index.html" title="Examples (ğŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable packages" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id=""></h1>

<h1 id="kurel-package-system---comprehensive-design-details">Kurel Package System - Comprehensive Design Details</h1>
<p>This document captures the complete design discussion, decisions, alternatives considered, and rationale for the Kurel (Kubernetes Resources Launcher) package system. It serves as a comprehensive record of all design choices made during the extensive design iteration process.</p>
<hr>
<h2 id="design-philosophy--core-principles">Design Philosophy &amp; Core Principles</h2>
<h3 id="fundamental-philosophy">Fundamental Philosophy</h3>
<p><strong>&ldquo;Kurel just generates YAML&rdquo;</strong> - This principle guided every design decision. Kurel is not a runtime system, orchestrator, or complex package manager. It&rsquo;s a declarative system for generating Kubernetes manifests with validation and customization capabilities.</p>
<h3 id="core-design-principles">Core Design Principles</h3>
<ol>
<li><strong>Explicit over Implicit</strong> - Always prefer explicit configuration over hidden defaults</li>
<li><strong>Flexible but Validated</strong> - Don&rsquo;t constrain unnecessarily but validate what we can</li>
<li><strong>GitOps Compatible</strong> - Generate proper Kubernetes manifests for GitOps workflows</li>
<li><strong>No Templating Engines</strong> - Use patches instead of complex template logic</li>
<li><strong>Deterministic Output</strong> - Same inputs always produce same outputs</li>
</ol>
<h3 id="key-design-constraints">Key Design Constraints</h3>
<ul>
<li>âŒ No templating or embedded logic in YAML</li>
<li>âŒ No overlays or merging strategies (use patches instead)</li>
<li>âŒ No conditionals or loops in YAML</li>
<li>âŒ No composition or shared libraries between packages</li>
<li>âœ… Variable substitution allowed, but only for keys in parameters.yaml</li>
<li>âœ… All patches are deterministic, declarative, and validated</li>
</ul>
<hr>
<h2 id="research-insights-from-existing-systems">Research Insights from Existing Systems</h2>
<p>The kurel design was informed by extensive research into existing package management and deployment systems. Here are the key insights that shaped our decisions:</p>
<h3 id="helm-charts-analysis">Helm Charts Analysis</h3>
<p><strong>Structure patterns adopted</strong>:</p>
<ul>
<li><code>Chart.yaml</code> â†’ Inspired our metadata in <code>parameters.yaml</code> under <code>kurel:</code> key</li>
<li><code>values.yaml</code> â†’ Our <code>parameters.yaml</code> serves similar purpose</li>
<li><code>templates/</code> â†’ Our <code>resources/</code> for base manifests</li>
</ul>
<p><strong>Patterns rejected</strong>:</p>
<ul>
<li>Complex templating with <code>{{ }}</code> syntax â†’ Use patches instead</li>
<li>Dependencies in <code>Chart.yaml</code> â†’ Handle at GitOps level</li>
<li><code>.helmignore</code> â†’ Not needed for kurel&rsquo;s simpler model</li>
</ul>
<h3 id="docker-compose-learnings">Docker Compose Learnings</h3>
<p><strong>Patterns adopted</strong>:</p>
<ul>
<li><code>docker-compose.override.yml</code> â†’ Our <code>.local.kurel</code> extension pattern</li>
<li>Environment variable substitution â†’ Our <code>${variable}</code> syntax</li>
<li>Service profiles â†’ Our conditional patch enabling</li>
</ul>
<p><strong>Insights gained</strong>:</p>
<ul>
<li>Override files work well for user customization</li>
<li>Simple variable substitution is sufficient for most cases</li>
<li>Profiles enable different deployment configurations</li>
</ul>
<h3 id="terraform-modules-study">Terraform Modules Study</h3>
<p><strong>Structure patterns adopted</strong>:</p>
<ul>
<li><code>variables.tf</code> â†’ Our parameter documentation approach</li>
<li><code>README.md</code> â†’ Documentation importance</li>
<li>Clear input/output interface â†’ Our parameters/generated manifests</li>
</ul>
<p><strong>Patterns adapted</strong>:</p>
<ul>
<li>Version constraints â†’ Decided to handle at GitOps level</li>
<li>Module composition â†’ Kept packages self-contained</li>
</ul>
<h3 id="kustomize-patterns">Kustomize Patterns</h3>
<p><strong>Concepts adopted</strong>:</p>
<ul>
<li><code>patches/</code> directory structure</li>
<li>Declarative customization without templating</li>
<li>Base + overlay pattern â†’ Our package + .local.kurel pattern</li>
</ul>
<p><strong>Improvements made</strong>:</p>
<ul>
<li>Better patch organization with subdirectories</li>
<li>Conditional patch application vs static overlays</li>
<li>Integrated variable system vs separate files</li>
</ul>
<h3 id="argocd-applications-research">ArgoCD Applications Research</h3>
<p><strong>Patterns adopted</strong>:</p>
<ul>
<li>Sync waves â†’ Our install phase annotations</li>
<li>Application dependencies â†’ Our phase-based deployment</li>
<li>Health checks â†’ Our wait-for-ready annotations</li>
</ul>
<p><strong>GitOps integration insights</strong>:</p>
<ul>
<li>Need for deployment ordering in complex applications</li>
<li>Importance of GitOps-native manifest generation</li>
<li>Value of dependency management at orchestration level</li>
</ul>
<h3 id="key-research-conclusions">Key Research Conclusions</h3>
<ol>
<li><strong>No single system does everything well</strong> - Each has strengths for specific use cases</li>
<li><strong>Templating complexity</strong> - Most users struggle with complex template syntax</li>
<li><strong>Override patterns work</strong> - Docker Compose override model is intuitive</li>
<li><strong>Validation is crucial</strong> - All successful systems provide parameter validation</li>
<li><strong>GitOps compatibility</strong> - Modern systems must integrate well with GitOps workflows</li>
</ol>
<hr>
<h2 id="package-structure-evolution">Package Structure Evolution</h2>
<h3 id="final-package-structure">Final Package Structure</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>my-app.kurel/
â”œâ”€â”€ parameters.yaml          # All variables + metadata
â”œâ”€â”€ resources/               # Base Kubernetes manifests (one GVK per file)
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ namespaces.yaml
â”œâ”€â”€ patches/                 # Modular patches with numeric ordering
â”‚   â”œâ”€â”€ 00-base.kpatch      # Standard global patterns (explicit)
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ 10-monitoring.kpatch
â”‚   â”‚   â”œâ”€â”€ 10-monitoring.yaml   # Patch metadata
â”‚   â”‚   â””â”€â”€ 20-ingress.kpatch
â”‚   â””â”€â”€ profiles/
â”‚       â”œâ”€â”€ 10-development.kpatch
â”‚       â””â”€â”€ 10-production.kpatch
â”œâ”€â”€ schemas/                 # Auto-generated validation
â”‚   â””â”€â”€ parameters.schema.json
â”œâ”€â”€ examples/               # Example configurations
â”‚   â””â”€â”€ production.yaml
â””â”€â”€ README.md              # Documentation

my-app.local.kurel/         # User extensions (optional)
â”œâ”€â”€ patches/                # Additional patches only
â”‚   â””â”€â”€ 50-custom.kpatch
â””â”€â”€ parameters.yaml         # Override parameter values</code></pre></div>
<h3 id="original-structure-rejected">Original Structure (Rejected)</h3>
<p>The initial design from the existing DESIGN.md included:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>my-app.kurel/
â”œâ”€â”€ resources/
â”œâ”€â”€ parameters.kpatch        # Single patch file
â”œâ”€â”€ config.kpatch           # Multi-resource patch set
â”œâ”€â”€ config.schema.json      # JSONSchema for validation
â”œâ”€â”€ instance.schema.json    # Schema for instance-level fields
â”œâ”€â”€ instance.yaml           # External instance configuration
â””â”€â”€ README.md</code></pre></div>
<h3 id="evolution--rejected-alternatives">Evolution &amp; Rejected Alternatives</h3>
<h4 id="directory-name">Directory Name</h4>
<ul>
<li><strong>Chosen</strong>: <code>my-app.kurel/</code> - Clear package identity</li>
<li><strong>Considered</strong>: <code>.kurel</code> suffix vs directory structure - decided on directory for better organization</li>
</ul>
<h4 id="patch-organization">Patch Organization</h4>
<ul>
<li><strong>Original</strong>: Single <code>parameters.kpatch</code> file</li>
<li><strong>Intermediate</strong>: <code>config.kpatch</code> for multi-resource patches</li>
<li><strong>Final</strong>: Multiple <code>.kpatch</code> files in <code>patches/</code> subdirectories</li>
<li><strong>Rationale</strong>: Better organization, modular patches, easier to maintain</li>
</ul>
<h4 id="configuration-files">Configuration Files</h4>
<ul>
<li><strong>Original</strong>: Separate <code>instance.yaml</code> external to package</li>
<li><strong>Final</strong>: <code>parameters.yaml</code> within package, <code>.local.kurel</code> for overrides</li>
<li><strong>Rationale</strong>: Simpler structure, explicit override pattern</li>
</ul>
<h4 id="metadata-location">Metadata Location</h4>
<ul>
<li><strong>Considered</strong>: Separate <code>kurel.yaml</code> for package metadata</li>
<li><strong>Final</strong>: Metadata in <code>parameters.yaml</code> under <code>kurel:</code> key</li>
<li><strong>Rationale</strong>: Single source of truth, metadata available as variables</li>
</ul>
<hr>
<h2 id="parameters-system-design">Parameters System Design</h2>
<h3 id="final-parameter-structure">Final Parameter Structure</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># parameters.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Package metadata (fixed key)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-operator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.68.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">appVersion</span>: <span style="color:#ae81ff">0.68.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Prometheus Operator creates/manages Prometheus clusters&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">home</span>: <span style="color:#ae81ff">https://github.com/prometheus-operator/prometheus-operator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">keywords</span>: [<span style="color:#e6db74">&#34;monitoring&#34;</span>, <span style="color:#e6db74">&#34;prometheus&#34;</span>, <span style="color:#e6db74">&#34;operator&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maintainers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Prometheus Team&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">email</span>: <span style="color:#e6db74">&#34;prometheus-operator@googlegroups.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global defaults (fixed key)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#e6db74">&#34;${kurel.name}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#e6db74">&#34;${kurel.appVersion}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/managed-by</span>: <span style="color:#e6db74">&#34;kurel&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kurel.gokure.dev/package</span>: <span style="color:#e6db74">&#34;${kurel.name}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kurel.gokure.dev/version</span>: <span style="color:#e6db74">&#34;${kurel.version}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128Mi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1000m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">65534</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">65534</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Author-defined variables (any structure)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#e6db74">&#34;${monitoring.enabled}&#34;</span>   <span style="color:#75715e"># Nested reference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">quay.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">prometheus-operator/prometheus-operator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#e6db74">&#34;v${kurel.appVersion}&#34;</span>         <span style="color:#75715e"># Reference to metadata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">size</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClass</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controller</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m   </span> <span style="color:#75715e"># Override global default</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">256Mi</span></span></span></code></pre></div>
<h3 id="variable-reference-system">Variable Reference System</h3>
<ul>
<li><strong>Syntax</strong>: <code>${section.subsection.value}</code> with dot notation</li>
<li><strong>Nested references supported</strong>: <code>${monitoring.serviceMonitor.enabled}</code> can reference <code>${monitoring.enabled}</code></li>
<li><strong>Metadata references</strong>: Variables can reference package metadata like <code>${kurel.appVersion}</code></li>
<li><strong>Global patterns</strong>: <code>${global.*}</code> for cross-cutting defaults</li>
</ul>
<h3 id="fixed-top-level-keys">Fixed Top-Level Keys</h3>
<h4 id="kurel-key-package-metadata"><code>kurel:</code> Key (Package Metadata)</h4>
<p><strong>Purpose</strong>: Package identification and metadata, also available as variables
<strong>Required fields</strong>:</p>
<ul>
<li><code>name</code>: Package name (used in generated resources)</li>
<li><code>version</code>: Package version</li>
<li><code>appVersion</code>: Upstream application version</li>
</ul>
<p><strong>Optional fields</strong>:</p>
<ul>
<li><code>description</code>: Human-readable description</li>
<li><code>home</code>: URL to project homepage</li>
<li><code>keywords</code>: Array of keywords for discovery</li>
<li><code>maintainers</code>: Array of maintainer objects</li>
</ul>
<h4 id="global-key-default-values"><code>global:</code> Key (Default Values)</h4>
<p><strong>Purpose</strong>: Default values applied across all resources via base patches
<strong>Common patterns</strong>:</p>
<ul>
<li><code>labels</code>: Applied to all resources</li>
<li><code>annotations</code>: Applied to all resources</li>
<li><code>resources</code>: Default resource requests/limits</li>
<li><code>securityContext</code>: Default security settings</li>
<li><code>nodeSelector</code>: Default node selection</li>
<li><code>tolerations</code>: Default tolerations</li>
<li><code>imagePullPolicy</code>: Default image pull policy</li>
</ul>
<h3 id="extendedvalue-evolution">ExtendedValue Evolution</h3>
<h4 id="original-extendedvalue-design-rejected">Original ExtendedValue Design (Rejected)</h4>
<p>We initially considered an &ldquo;ExtendedValue&rdquo; struct to provide validation metadata:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Original ExtendedValue approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">persistence</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">size</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">_schema</span>: <span style="color:#ae81ff">extended       </span> <span style="color:#75715e"># Explicit marker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pattern</span>: <span style="color:#e6db74">&#34;^[0-9]+[KMGT]i$&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Storage size in Kubernetes format&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">minimum</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">maximum</span>: <span style="color:#66d9ef">null</span></span></span></code></pre></div>
<h4 id="detection-problem">Detection Problem</h4>
<p>The challenge was distinguishing between ExtendedValue objects and regular nested configuration:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Is this an ExtendedValue or regular config?</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">database</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">credentials</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">secret-ref   </span> <span style="color:#75715e"># Could be ExtendedValue.value or just a config key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">kubernetes    </span> <span style="color:#75715e"># Could be ExtendedValue.type or just a config key</span></span></span></code></pre></div>
<h4 id="final-decision-direct-schema-generation">Final Decision: Direct Schema Generation</h4>
<p><strong>Chosen approach</strong>: Generate JSON Schema directly from parameters.yaml + K8s API tracing
<strong>Rationale</strong>:</p>
<ul>
<li>Avoids duplication between ExtendedValue and schema</li>
<li>Leverages existing Kubernetes validation</li>
<li>Cleaner parameter files</li>
<li>Standard JSON Schema tooling support</li>
</ul>
<h3 id="parameter-override-system">Parameter Override System</h3>
<h4 id="resolution-order">Resolution Order</h4>
<ol>
<li><strong>Package <code>parameters.yaml</code></strong> - Base values and metadata</li>
<li><strong>Local <code>my-app.local.kurel/parameters.yaml</code></strong> - User overrides (highest priority)</li>
<li><strong>Error if variable not found</strong></li>
</ol>
<h4 id="local-override-pattern">Local Override Pattern</h4>
<ul>
<li><strong>Same filename</strong>: <code>parameters.yaml</code> in both locations</li>
<li><strong>Rejected alternatives</strong>: <code>values.yaml</code>, <code>overrides.yaml</code>, <code>local.yaml</code></li>
<li><strong>Rationale</strong>: Consistency and simplicity</li>
</ul>
<hr>
<h2 id="patch-system-architecture">Patch System Architecture</h2>
<h3 id="patch-discovery--organization">Patch Discovery &amp; Organization</h3>
<h4 id="file-organization">File Organization</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>patches/
â”œâ”€â”€ 00-base.kpatch          # Global patterns (explicit)
â”œâ”€â”€ features/               # Feature-specific patches
â”‚   â”œâ”€â”€ 10-monitoring.kpatch
â”‚   â”œâ”€â”€ 10-monitoring.yaml  # Patch metadata
â”‚   â”œâ”€â”€ 20-ingress.kpatch
â”‚   â””â”€â”€ 30-persistence.kpatch
â”œâ”€â”€ profiles/               # Environment profiles
â”‚   â”œâ”€â”€ 10-development.kpatch
â”‚   â”œâ”€â”€ 20-staging.kpatch
â”‚   â””â”€â”€ 30-production.kpatch
â””â”€â”€ resources/              # Resource-specific patches
    â”œâ”€â”€ 10-limits-small.kpatch
    â”œâ”€â”€ 20-limits-medium.kpatch
    â””â”€â”€ 30-limits-large.kpatch</code></pre></div>
<h4 id="naming-convention-evolution">Naming Convention Evolution</h4>
<ul>
<li><strong>Initial idea</strong>: Required prefixes like <code>feature-</code>, <code>profile-</code></li>
<li><strong>Final decision</strong>: Numeric prefixes only: <code>NN-descriptive-name.kpatch</code></li>
<li><strong>Rationale</strong>: Flexibility without unnecessary constraints</li>
</ul>
<h4 id="numeric-prefix-guidelines-rejected">Numeric Prefix Guidelines (Rejected)</h4>
<p>We considered prescriptive numeric ranges:</p>
<ul>
<li>10-19: Core features/settings</li>
<li>20-29: Additional features</li>
<li>30-39: Advanced/optional features</li>
<li>90-99: Override/cleanup patches</li>
</ul>
<p><strong>Decision</strong>: No prescribed ranges - users decide their own numbering system
<strong>Rationale</strong>: Avoid artificial constraints, let package authors organize as they see fit</p>
<h4 id="directory-structure-preferences">Directory Structure Preferences</h4>
<ul>
<li><strong>Allow</strong>: Direct patches in <code>patches/</code> root</li>
<li><strong>Prefer</strong>: Subdirectories for organization</li>
<li><strong>Rationale</strong>: Flexibility with gentle guidance toward better organization</li>
</ul>
<h3 id="patch-discovery--ordering">Patch Discovery &amp; Ordering</h3>
<h4 id="discovery-pattern">Discovery Pattern</h4>
<ul>
<li><strong>Glob</strong>: <code>patches/**/*.kpatch</code></li>
<li><strong>Processing order</strong>: Alphabetical by full path (directory + filename)</li>
<li><strong>Numeric sorting</strong>: <code>10-</code> comes before <code>20-</code> comes before <code>9-</code> (string sort)</li>
</ul>
<h4 id="example-processing-order">Example Processing Order</h4>
<ol>
<li><code>patches/00-base.kpatch</code></li>
<li><code>patches/features/10-monitoring.kpatch</code></li>
<li><code>patches/features/20-ingress.kpatch</code></li>
<li><code>patches/profiles/10-development.kpatch</code></li>
<li><code>patches/resources/10-limits-small.kpatch</code></li>
</ol>
<h3 id="conditional-patch-enabling">Conditional Patch Enabling</h3>
<h4 id="patch-metadata-files">Patch Metadata Files</h4>
<p>Each patch can have a corresponding <code>.yaml</code> file with the same base name:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># features/10-monitoring.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">enabled</span>: <span style="color:#e6db74">&#34;${monitoring.enabled}&#34;</span>      <span style="color:#75715e"># Simple boolean expression</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Adds Prometheus monitoring sidecars and annotations&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">requires</span>:                            <span style="color:#75715e"># Auto-enable these patches</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/05-metrics-base.kpatch&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/15-monitoring-rbac.kpatch&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">conflicts</span>:                           <span style="color:#75715e"># Cannot be enabled together</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/25-lightweight-monitoring.kpatch&#34;</span></span></span></code></pre></div>
<h4 id="enabling-expression-language">Enabling Expression Language</h4>
<ul>
<li><strong>Chosen</strong>: Simple boolean variables only</li>
<li><strong>Syntax</strong>: <code>&quot;${variable.name}&quot;</code> evaluates to true/false</li>
<li><strong>Rejected</strong>: Complex expressions like <code>&quot;${environment == 'production'}&quot;</code></li>
<li><strong>Rationale</strong>: Keep it simple, avoid expression language complexity</li>
</ul>
<h4 id="dependency-resolution-evolution">Dependency Resolution Evolution</h4>
<p><strong>Option A: Requirements as Prerequisites (Initially Chosen)</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">requires</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/10-metrics-base.kpatch&#34;</span></span></span></code></pre></div>
<ul>
<li>If <code>metrics-base</code> NOT enabled â†’ Error: &ldquo;monitoring requires metrics-base&rdquo;</li>
<li>User must explicitly enable both patches</li>
<li>More explicit control, prevents surprises</li>
</ul>
<p><strong>Option B: Requirements with Auto-Enable (Final Choice)</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">requires</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/10-metrics-base.kpatch&#34;</span></span></span></code></pre></div>
<ul>
<li>If <code>monitoring</code> enabled â†’ automatically enables <code>metrics-base</code></li>
<li>Creates dependency chains</li>
<li>Transitive dependencies supported</li>
<li>User changed mind during design process</li>
</ul>
<p><strong>Rationale for change</strong>: User convenience outweighs explicitness concern</p>
<h4 id="dependency-resolution-process">Dependency Resolution Process</h4>
<ol>
<li><strong>Parse all patch metadata</strong> files</li>
<li><strong>Evaluate <code>enabled</code> expressions</strong> against parameters</li>
<li><strong>Build dependency graph</strong> from <code>requires</code> fields</li>
<li><strong>Auto-enable required patches</strong> transitively</li>
<li><strong>Check for conflicts</strong> between enabled patches</li>
<li><strong>Detect circular dependencies</strong></li>
<li><strong>Report what was auto-enabled</strong> to user</li>
</ol>
<h4 id="conflict-resolution">Conflict Resolution</h4>
<ul>
<li><strong>Error on conflicts</strong>: Cannot enable conflicting patches simultaneously</li>
<li><strong>Example</strong>: Monitoring and lightweight-monitoring are mutually exclusive</li>
<li><strong>User feedback</strong>: Clear error messages explaining conflicts</li>
</ul>
<h3 id="base-patch-pattern">Base Patch Pattern</h3>
<h4 id="evolution-from-implicit-to-explicit">Evolution from Implicit to Explicit</h4>
<p><strong>Original idea</strong>: Automatic <code>base.kpatch</code> applied to all resources
<strong>Problem</strong>: If it&rsquo;s always applied, why not just update the base YAML?
<strong>Final decision</strong>: Explicit <code>00-base.kpatch</code> that package author must include</p>
<h4 id="base-patch-content">Base Patch Content</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># patches/00-base.kpatch - Applied to all resources</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global labels and annotations</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">labels</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.labels}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">annotations</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.annotations}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply to all Deployments</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">deployment</span>.<span style="color:#960050;background-color:#1e0010">*</span>.<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">spec</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">securityContext</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.securityContext}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nodeSelector</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.nodeSelector}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tolerations</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.tolerations}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply to all containers in all Deployments</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">deployment</span>.<span style="color:#960050;background-color:#1e0010">*</span>.<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">containers</span>.<span style="color:#960050;background-color:#1e0010">*</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">resources</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.resources}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">imagePullPolicy</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.imagePullPolicy}&#34;</span></span></span></code></pre></div>
<h4 id="what-goes-in-base-patches">What Goes in Base Patches</h4>
<ul>
<li><strong>Cross-cutting concerns</strong>: Labels, annotations applied to all resources</li>
<li><strong>Security defaults</strong>: SecurityContext, RBAC patterns</li>
<li><strong>Resource defaults</strong>: CPU/memory requests and limits</li>
<li><strong>Image patterns</strong>: Registry, pull policies</li>
<li><strong>Scheduling</strong>: Node selectors, tolerations, affinity</li>
</ul>
<h3 id="toml-headers-clarification">TOML Headers Clarification</h3>
<h4 id="what-we-kept">What We Kept</h4>
<ul>
<li><strong>Standard TOML headers</strong> for patch targeting remain part of the core patch design</li>
<li><strong>Example</strong>: <code>[deployment.my-app.spec.template.spec.containers.0]</code></li>
</ul>
<h4 id="what-we-rejected">What We Rejected</h4>
<ul>
<li><strong>Special TOML headers</strong> for variable definitions in patch files</li>
<li><strong>Example</strong> (rejected):
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">variables</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cpu_request</span> = <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memory_request</span> = <span style="color:#e6db74">&#34;128Mi&#34;</span></span></span></code></pre></div>
</li>
</ul>
<h4 id="final-decision">Final Decision</h4>
<ul>
<li><strong>All variable definitions</strong> go in <code>parameters.yaml</code></li>
<li><strong>Patch files</strong> contain only targeting headers and patch operations</li>
<li><strong>Metadata files</strong> (<code>.yaml</code>) contain patch enabling/dependency info</li>
<li><strong>Clean separation</strong> of concerns</li>
</ul>
<hr>
<h2 id="multi-namespace-support--validation">Multi-Namespace Support &amp; Validation</h2>
<h3 id="namespace-handling-philosophy">Namespace Handling Philosophy</h3>
<h4 id="design-decision-full-flexibility">Design Decision: Full Flexibility</h4>
<ul>
<li><strong>Allow</strong>: Resources targeting any namespaces</li>
<li><strong>Allow</strong>: Creating multiple namespaces</li>
<li><strong>Allow</strong>: Cross-namespace references</li>
<li><strong>Rejected</strong>: Single-namespace enforcement (like some Helm charts)</li>
<li><strong>Rationale</strong>: &ldquo;kurel just generates YAML&rdquo; - don&rsquo;t artificially constrain users</li>
</ul>
<h4 id="example-multi-namespace-package">Example Multi-Namespace Package</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># resources/namespaces.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">apps</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resources/deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">apps     </span> <span style="color:#75715e"># Different namespace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resources/service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring </span> <span style="color:#75715e"># Another namespace</span></span></span></code></pre></div>
<h3 id="namespace-creation-control">Namespace Creation Control</h3>
<h4 id="control-mechanism">Control Mechanism</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># parameters.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespaces</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create: true         # Default</span>: <span style="color:#ae81ff">create namespaces</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">exclude</span>:             <span style="color:#75715e"># Don&#39;t create these</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;kube-system&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;default&#34;</span></span></span></code></pre></div>
<h4 id="base-patch-integration">Base Patch Integration</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># patches/00-base.kpatch - Conditional namespace creation</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">namespace</span>.<span style="color:#960050;background-color:#1e0010">$</span>{<span style="color:#a6e22e">monitoring</span>.<span style="color:#a6e22e">namespace</span>}]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.namespaces.create}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">labels</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.labels}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">annotations</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${global.annotations}&#34;</span></span></span></code></pre></div>
<h4 id="manual-namespace-control">Manual Namespace Control</h4>
<p>Users can disable specific namespace creation:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># patches/99-namespace-overrides.kpatch</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">namespace</span>.<span style="color:#a6e22e">kube-system</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">enabled</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">false</span>  <span style="color:#75715e"># Don&#39;t try to create kube-system</span></span></span></code></pre></div>
<h3 id="validation-scope--approach">Validation Scope &amp; Approach</h3>
<h4 id="validation-scope-decision">Validation Scope Decision</h4>
<ul>
<li><strong>Within package only</strong>: Check conflicts within the generated manifests</li>
<li><strong>Not against live cluster</strong>: No validation against existing cluster resources</li>
<li><strong>Rationale</strong>: Keep kurel simple, cluster validation is GitOps tool responsibility</li>
</ul>
<h4 id="validation-checks">Validation Checks</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kurel validate my-app.kurel/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ“ No naming conflicts within namespaces
</span></span><span style="display:flex;"><span>âœ“ Resources reference consistent namespaces  
</span></span><span style="display:flex;"><span>âš  Warning: Resources use namespace <span style="color:#e6db74">&#39;custom-ns&#39;</span> but no Namespace resource found
</span></span><span style="display:flex;"><span>   â†’ Enable global.namespaces.create<span style="color:#f92672">=</span>true or create Namespace resource manually
</span></span><span style="display:flex;"><span>âœ“ Cross-namespace Serviceâ†’Deployment references look valid
</span></span><span style="display:flex;"><span>âœ“ All patch variable references exist in parameters.yaml
</span></span><span style="display:flex;"><span>âœ— Error: Two Services named <span style="color:#e6db74">&#39;api&#39;</span> in namespace <span style="color:#e6db74">&#39;apps&#39;</span></span></span></code></pre></div>
<h4 id="cross-namespace-reference-validation">Cross-Namespace Reference Validation</h4>
<ul>
<li><strong>Basic validation</strong>: Check that referenced resources exist in package</li>
<li><strong>Example</strong>: Service targeting Deployment in different namespace</li>
<li><strong>Future enhancement</strong>: More sophisticated reference checking</li>
</ul>
<hr>
<h2 id="gitops-integration--deployment-phases">GitOps Integration &amp; Deployment Phases</h2>
<h3 id="install-phase-annotations">Install Phase Annotations</h3>
<h4 id="annotation-design">Annotation Design</h4>
<ul>
<li><strong>Domain</strong>: <code>kurel.gokure.dev/</code> (uses our domain as discussed)</li>
<li><strong>Install phase</strong>: <code>kurel.gokure.dev/install-phase</code></li>
<li><strong>Valid values</strong>: <code>pre-install</code>, <code>main</code>, <code>post-install</code></li>
<li><strong>Default</strong>: <code>main</code> if not specified</li>
</ul>
<h4 id="additional-control-annotations">Additional Control Annotations</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Resource-level deployment control</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kurel.gokure.dev/install-phase</span>: <span style="color:#e6db74">&#34;pre-install&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kurel.gokure.dev/wait-for-ready</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kurel.gokure.dev/timeout</span>: <span style="color:#e6db74">&#34;5m&#34;</span></span></span></code></pre></div>
<h4 id="three-phase-deployment-pattern">Three-Phase Deployment Pattern</h4>
<ol>
<li><strong>Pre-install</strong>: CRDs, namespaces, RBAC, secrets</li>
<li><strong>Main</strong>: Primary application resources (default)</li>
<li><strong>Post-install</strong>: Monitoring, backups, optional components</li>
</ol>
<h3 id="flux-translation-example">Flux Translation Example</h3>
<h4 id="generated-kustomization-structure">Generated Kustomization Structure</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>kustomizations/
â”œâ”€â”€ my-app-pre-install/
â”‚   â”œâ”€â”€ kustomization.yaml    # No dependencies
â”‚   â””â”€â”€ ...
â”œâ”€â”€ my-app-main/
â”‚   â”œâ”€â”€ kustomization.yaml    # Depends on: my-app-pre-install
â”‚   â””â”€â”€ ...
â””â”€â”€ my-app-post-install/
    â”œâ”€â”€ kustomization.yaml    # Depends on: my-app-main
    â””â”€â”€ ...</code></pre></div>
<h4 id="flux-kustomization-dependencies">Flux Kustomization Dependencies</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># my-app-main/kustomization.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.toolkit.fluxcd.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-app-main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dependsOn</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-app-pre-install</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># ... rest of spec</span></span></span></code></pre></div>
<h3 id="argocd-compatibility">ArgoCD Compatibility</h3>
<ul>
<li><strong>Sync waves</strong>: Install phases can map to ArgoCD sync wave annotations</li>
<li><strong>Health checks</strong>: Compatible with ArgoCD health assessment</li>
<li><strong>Dependency management</strong>: ArgoCD can handle phase dependencies</li>
</ul>
<h3 id="patch-modification-of-phases">Patch Modification of Phases</h3>
<ul>
<li><strong>Patches can modify</strong> install phase annotations</li>
<li><strong>Use case</strong>: User wants to move a resource to different phase</li>
<li><strong>Example</strong>:
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># User patch to move monitoring to pre-install</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">monitoring</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">annotations</span>[<span style="color:#e6db74">&#34;kurel.gokure.dev/install-phase&#34;</span>]<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;pre-install&#34;</span></span></span></code></pre></div>
</li>
</ul>
<hr>
<h2 id="user-extension-system">User Extension System</h2>
<h3 id="localkurel-design-pattern">.local.kurel Design Pattern</h3>
<h4 id="design-philosophy">Design Philosophy</h4>
<ul>
<li><strong>Simple overlay model</strong>: Local extends, doesn&rsquo;t modify package</li>
<li><strong>Docker Compose inspiration</strong>: Similar to <code>docker-compose.override.yml</code></li>
<li><strong>No resource overrides</strong>: Can only add patches, not replace base resources</li>
</ul>
<h4 id="extension-structure">Extension Structure</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>my-app.local.kurel/
â”œâ”€â”€ patches/                # Additional patches only
â”‚   â”œâ”€â”€ 50-custom-limits.kpatch
â”‚   â”œâ”€â”€ 60-local-config.kpatch
â”‚   â””â”€â”€ team/
â”‚       â””â”€â”€ 70-team-policy.kpatch
â””â”€â”€ parameters.yaml         # Override parameter values</code></pre></div>
<h4 id="processing-order">Processing Order</h4>
<ol>
<li><strong>Load package parameters.yaml</strong></li>
<li><strong>Merge local parameters.yaml</strong> (local values override package values)</li>
<li><strong>Resolve all variables</strong> with final parameter values</li>
<li><strong>Apply package patches</strong> (enabled based on final parameters)</li>
<li><strong>Apply local patches</strong> (enabled based on final parameters)</li>
</ol>
<h4 id="local-patch-capabilities--restrictions">Local Patch Capabilities &amp; Restrictions</h4>
<p><strong>Can do</strong>:</p>
<ul>
<li>Add new patches that apply to any resources</li>
<li>Use any variables from merged parameters</li>
<li>Target any resources generated by package</li>
</ul>
<p><strong>Cannot do</strong>:</p>
<ul>
<li>Reference package patches in <code>requires</code> field</li>
<li>Override or disable package patches directly</li>
<li>Replace base resources (only patch them)</li>
</ul>
<p><strong>Rationale</strong>: Keep local extensions simple and avoid complex interactions</p>
<h3 id="rejected-extension-patterns">Rejected Extension Patterns</h3>
<h4 id="multiple-overlay-types">Multiple Overlay Types</h4>
<p><strong>Considered</strong>: <code>.env.kurel</code>, <code>.team.kurel</code>, <code>.local.kurel</code> for different contexts
<strong>Rejected</strong>: Too complex, single <code>.local.kurel</code> is sufficient
<strong>Rationale</strong>: Most users need one level of customization</p>
<h4 id="direct-patch-disabling">Direct Patch Disabling</h4>
<p><strong>Considered</strong>: Allow local config to disable package patches</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">disable_patches</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;features/20-monitoring.kpatch&#34;</span></span></span></code></pre></div>
<p><strong>Rejected</strong>: User can already control this via parameter values
<strong>Rationale</strong>: Don&rsquo;t duplicate control mechanisms</p>
<h4 id="resource-replacement">Resource Replacement</h4>
<p><strong>Considered</strong>: Allow local extensions to replace base resources
<strong>Rejected</strong>: Too complex, patches are sufficient
<strong>Rationale</strong>: Maintain clear separation between base resources and customizations</p>
<hr>
<h2 id="schema-generation--validation">Schema Generation &amp; Validation</h2>
<h3 id="schema-generation-approach">Schema Generation Approach</h3>
<h4 id="three-phase-strategy">Three-Phase Strategy</h4>
<p><strong>Phase 1: Basic Type Inference</strong></p>
<ul>
<li>Scan <code>parameters.yaml</code> and infer types from current values</li>
<li><code>3</code> â†’ <code>&quot;type&quot;: &quot;integer&quot;</code></li>
<li><code>true</code> â†’ <code>&quot;type&quot;: &quot;boolean&quot;</code></li>
<li><code>&quot;10Gi&quot;</code> â†’ <code>&quot;type&quot;: &quot;string&quot;</code> with K8s quantity pattern detection</li>
</ul>
<p><strong>Phase 2: Kubernetes Path Tracing</strong></p>
<ul>
<li>Parse all <code>.kpatch</code> files for variable usage</li>
<li>Trace patch paths to Kubernetes resource fields</li>
<li>Query Kubernetes OpenAPI schemas for validation rules</li>
<li>Generate constraints based on K8s field definitions</li>
</ul>
<p><strong>Phase 3: Manual Overrides</strong></p>
<ul>
<li>Support manual schema additions for complex cases</li>
<li>Allow override of auto-generated constraints</li>
<li>Handle cases where tracing fails or is insufficient</li>
</ul>
<h4 id="path-tracing-example">Path Tracing Example</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># parameters.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">1Gi</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span><span style="color:#75715e"># patches/10-scale.kpatch</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">my-app</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">replicas</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${replicas}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">limits</span>.<span style="color:#a6e22e">memory</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${resources.memory}&#34;</span></span></span></code></pre></div>
<p><strong>Tracing process</strong>:</p>
<ol>
<li><code>${replicas}</code> â†’ <code>deployment.spec.replicas</code> â†’ K8s: integer, minimum: 0</li>
<li><code>${resources.memory}</code> â†’ <code>container.resources.limits.memory</code> â†’ K8s: string, K8s quantity format</li>
</ol>
<p><strong>Generated schema</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;replicas&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;minimum&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Number of replicas (from Deployment.spec.replicas)&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;resources&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;memory&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;pattern&#34;</span>: <span style="color:#e6db74">&#34;^[0-9]+[KMGT]i$&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Memory limit (from Container.resources.limits.memory)&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h3 id="validation-command-design">Validation Command Design</h3>
<h4 id="comprehensive-validation">Comprehensive Validation</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kurel validate my-app.kurel/ --values custom-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ“ Validating parameters against generated schema
</span></span><span style="display:flex;"><span>âœ“ Validating patch variable references  
</span></span><span style="display:flex;"><span>âœ“ Checking patch dependencies and conflicts
</span></span><span style="display:flex;"><span>âœ“ Validating generated Kubernetes resources
</span></span><span style="display:flex;"><span>âš  Warning: Variable <span style="color:#e6db74">&#39;monitoring.retention&#39;</span> used but not in schema
</span></span><span style="display:flex;"><span>âœ— Error: persistence.size <span style="color:#e6db74">&#34;10GB&#34;</span> doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t match pattern <span style="color:#e6db74">&#34;^[0-9]+[KMGT]i</span>$<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>âœ— Error: Circular dependency: monitoring â†’ metrics â†’ monitoring</span></span></code></pre></div>
<h4 id="validation-levels">Validation Levels</h4>
<ol>
<li><strong>Parameter schema validation</strong>: User values against generated/manual schema</li>
<li><strong>Variable reference validation</strong>: All <code>${...}</code> exist in parameters</li>
<li><strong>Patch dependency validation</strong>: No circular dependencies, no conflicts</li>
<li><strong>Kubernetes resource validation</strong>: Against K8s OpenAPI when possible</li>
<li><strong>Naming conflict validation</strong>: Within package scope</li>
</ol>
<h3 id="crd-support-strategy">CRD Support Strategy</h3>
<h4 id="well-known-crds">Well-Known CRDs</h4>
<ul>
<li><strong>Start</strong>: Support popular CRDs (Cert-Manager, External Secrets, MetalLB)</li>
<li><strong>Mechanism</strong>: Bundle known CRD schemas with kurel</li>
<li><strong>Discovery</strong>: Detect CRD usage in patches and apply appropriate schemas</li>
</ul>
<h4 id="custom-crds">Custom CRDs</h4>
<ul>
<li><strong>Future</strong>: Allow users to provide CRD schemas</li>
<li><strong>Mechanism</strong>: <code>schemas/crds/</code> directory in package</li>
<li><strong>Auto-detection</strong>: Parse CRD YAML to extract schema</li>
</ul>
<h3 id="schema-distribution">Schema Distribution</h3>
<h4 id="generation-strategy">Generation Strategy</h4>
<ul>
<li><strong>On-demand generation</strong>: Generate schemas when needed</li>
<li><strong>Caching</strong>: Cache generated schemas for performance</li>
<li><strong>Version awareness</strong>: Regenerate when parameters or patches change</li>
</ul>
<h4 id="pre-generation-rejected">Pre-generation (Rejected)</h4>
<p><strong>Considered</strong>: Include pre-generated schemas in packages
<strong>Rejected</strong>: Adds complexity, schemas can become stale
<strong>Rationale</strong>: Generate fresh schemas ensure accuracy</p>
<hr>
<h2 id="rejected-features--design-alternatives">Rejected Features &amp; Design Alternatives</h2>
<h3 id="package-dependencies">Package Dependencies</h3>
<h4 id="what-was-considered">What Was Considered</h4>
<p>Helm-style package dependencies with version constraints:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-app</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dependencies</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">postgresql</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;&gt;=11.0.0&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">repository</span>: <span style="color:#e6db74">&#34;https://charts.bitnami.com&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;^6.0.0&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">caching.enabled</span></span></span></code></pre></div>
<h4 id="why-rejected">Why Rejected</h4>
<ul>
<li><strong>Philosophy conflict</strong>: &ldquo;kurel just generates YAML&rdquo;</li>
<li><strong>Complexity</strong>: Would require package registry, version resolution</li>
<li><strong>Better handled elsewhere</strong>: GitOps tools (Flux/ArgoCD) handle dependencies</li>
<li><strong>User preference</strong>: Dependencies &ldquo;explicitly configured at higher level&rdquo;</li>
</ul>
<h3 id="rbac-auto-management">RBAC Auto-Management</h3>
<h4 id="what-was-considered-1">What Was Considered</h4>
<p>Automatic RBAC generation and validation:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rbac</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">permissions</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]</span></span></code></pre></div>
<h4 id="why-rejected-1">Why Rejected</h4>
<ul>
<li><strong>No clear &ldquo;automagical&rdquo; benefit</strong>: RBAC requirements are application-specific</li>
<li><strong>Simple alternative</strong>: Include RBAC resources in <code>resources/</code> like any other K8s resource</li>
<li><strong>Validation complexity</strong>: Hard to automatically determine required permissions</li>
<li><strong>Philosophy</strong>: Keep kurel focused on YAML generation, not security analysis</li>
</ul>
<h3 id="multi-tenancy-enforcement">Multi-Tenancy Enforcement</h3>
<h4 id="what-was-considered-2">What Was Considered</h4>
<p>Built-in tenancy validation and namespace enforcement:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tenancy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">strict</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">allowedNamespaces</span>: [<span style="color:#e6db74">&#34;app-*&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resourceNaming</span>: <span style="color:#ae81ff">tenant-prefixed</span></span></span></code></pre></div>
<h4 id="why-rejected-2">Why Rejected</h4>
<ul>
<li><strong>Higher-level concern</strong>: Tenancy better handled by GitOps tools and admission controllers</li>
<li><strong>Flexibility loss</strong>: Would constrain valid use cases unnecessarily</li>
<li><strong>Philosophy</strong>: kurel generates YAML, tenancy tools enforce policies</li>
</ul>
<h3 id="complex-expression-language">Complex Expression Language</h3>
<h4 id="what-was-considered-3">What Was Considered</h4>
<p>Rich expression language for patch enabling:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">enabled</span>: <span style="color:#e6db74">&#34;${environment == &#39;production&#39; &amp;&amp; monitoring.enabled &amp;&amp; !minimal_install}&#34;</span></span></span></code></pre></div>
<h4 id="why-rejected-3">Why Rejected</h4>
<ul>
<li><strong>Complexity</strong>: Would require expression parser and evaluator</li>
<li><strong>Simple alternative</strong>: Boolean variables work for most cases</li>
<li><strong>Debugging difficulty</strong>: Complex expressions hard to troubleshoot</li>
<li><strong>Philosophy</strong>: Keep patch enabling simple and predictable</li>
</ul>
<h3 id="conditional-yaml-structures">Conditional YAML Structures</h3>
<h4 id="what-was-considered-4">What Was Considered</h4>
<p>Helm-style conditional blocks in YAML:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach (Helm-style)</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">if .Values.persistence.enabled }}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">data</span>
</span></span><span style="display:flex;"><span>{{- <span style="color:#ae81ff">end }}</span></span></span></code></pre></div>
<h4 id="why-rejected-4">Why Rejected</h4>
<ul>
<li><strong>Design constraint</strong>: No templating or embedded logic</li>
<li><strong>Alternative</strong>: Use patches to add/remove structures</li>
<li><strong>Cleaner separation</strong>: Base YAML + patches vs templated YAML</li>
</ul>
<h3 id="pre-generated-schemas-in-packages">Pre-Generated Schemas in Packages</h3>
<h4 id="what-was-considered-5">What Was Considered</h4>
<p>Include generated schemas in package distribution:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>my-app.kurel/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ parameters.schema.json    # Pre-generated
â”‚   â””â”€â”€ resources.schema.json     # Pre-generated</code></pre></div>
<h4 id="why-rejected-5">Why Rejected</h4>
<ul>
<li><strong>Staleness risk</strong>: Schemas become outdated when parameters change</li>
<li><strong>Build complexity</strong>: Requires build step to generate schemas</li>
<li><strong>Size overhead</strong>: Adds to package size unnecessarily</li>
<li><strong>Alternative</strong>: Generate on-demand with caching</li>
</ul>
<h3 id="complex-package-composition">Complex Package Composition</h3>
<h4 id="what-was-considered-6">What Was Considered</h4>
<p>Ability to compose packages from multiple sources:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Rejected approach</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-app</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">includes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">package</span>: <span style="color:#ae81ff">base-app</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">patches</span>: [<span style="color:#e6db74">&#34;security/*&#34;</span>]
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">package</span>: <span style="color:#ae81ff">monitoring  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span></span></span></code></pre></div>
<h4 id="why-rejected-6">Why Rejected</h4>
<ul>
<li><strong>Complexity</strong>: Would require dependency resolution, version management</li>
<li><strong>Philosophy</strong>: Keep packages self-contained</li>
<li><strong>Alternative</strong>: Copy/fork packages for customization</li>
</ul>
<hr>
<h2 id="implementation-considerations">Implementation Considerations</h2>
<h3 id="cli-command-design">CLI Command Design</h3>
<h4 id="core-commands">Core Commands</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Validate package and user configuration</span>
</span></span><span style="display:flex;"><span>kurel validate my-app.kurel/ --values custom-values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate schemas from package</span>
</span></span><span style="display:flex;"><span>kurel schema generate my-app.kurel/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build final manifests</span>
</span></span><span style="display:flex;"><span>kurel build my-app.kurel/ --values custom-values.yaml --output ./manifests/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Package information</span>
</span></span><span style="display:flex;"><span>kurel info my-app.kurel/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List available patches and their status</span>
</span></span><span style="display:flex;"><span>kurel patches list my-app.kurel/ --values custom-values.yaml</span></span></code></pre></div>
<h4 id="validation-output-design">Validation Output Design</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kurel validate my-app.kurel/ --values production.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ“ Package structure valid
</span></span><span style="display:flex;"><span>âœ“ Parameters schema validation passed
</span></span><span style="display:flex;"><span>âœ“ All patch variables resolved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enabled patches:
</span></span><span style="display:flex;"><span>  âœ“ patches/00-base.kpatch <span style="color:#f92672">(</span>always enabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  âœ“ patches/features/10-monitoring.kpatch <span style="color:#f92672">(</span>monitoring.enabled<span style="color:#f92672">=</span>true<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  â†’ patches/features/05-metrics-base.kpatch <span style="color:#f92672">(</span>required by 10-monitoring<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  â†’ patches/features/15-monitoring-rbac.kpatch <span style="color:#f92672">(</span>required by 10-monitoring<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  âœ— patches/features/20-ingress.kpatch <span style="color:#f92672">(</span>conflicts with 25-simple-ingress<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Generated resources:
</span></span><span style="display:flex;"><span>  âœ“ <span style="color:#ae81ff">3</span> Namespaces
</span></span><span style="display:flex;"><span>  âœ“ <span style="color:#ae81ff">5</span> Deployments  
</span></span><span style="display:flex;"><span>  âœ“ <span style="color:#ae81ff">8</span> Services
</span></span><span style="display:flex;"><span>  âœ“ <span style="color:#ae81ff">2</span> Ingresses
</span></span><span style="display:flex;"><span>  âš  Warning: Resources span <span style="color:#ae81ff">3</span> namespaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Validation summary: <span style="color:#ae81ff">1</span> error, <span style="color:#ae81ff">1</span> warning</span></span></code></pre></div>
<h3 id="variable-resolution-engine">Variable Resolution Engine</h3>
<h4 id="resolution-algorithm">Resolution Algorithm</h4>
<ol>
<li><strong>Parse parameter files</strong>: Package + local override</li>
<li><strong>Build variable map</strong>: Flatten nested structure to dot notation</li>
<li><strong>Scan patch files</strong>: Extract all <code>${...}</code> references</li>
<li><strong>Validate references</strong>: Ensure all variables exist</li>
<li><strong>Resolve nested references</strong>: Handle <code>${a.b}</code> where <code>a.b: &quot;${c.d}&quot;</code></li>
<li><strong>Type casting</strong>: Apply schema-based type conversion</li>
<li><strong>Circular dependency detection</strong>: Prevent infinite resolution</li>
</ol>
<h4 id="variable-resolution-example">Variable Resolution Example</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># parameters.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kurel</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">appVersion</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#e6db74">&#34;v${kurel.appVersion}&#34;</span>    <span style="color:#75715e"># References metadata</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">full</span>: <span style="color:#e6db74">&#34;${image.registry}/${image.repository}:${image.tag}&#34;</span></span></span></code></pre></div>
<p><strong>Resolution steps</strong>:</p>
<ol>
<li><code>kurel.appVersion</code> = <code>&quot;1.0.0&quot;</code></li>
<li><code>image.tag</code> = <code>&quot;v${kurel.appVersion}&quot;</code> â†’ <code>&quot;v1.0.0&quot;</code></li>
<li><code>image.full</code> = <code>&quot;${image.registry}/${image.repository}:${image.tag}&quot;</code> â†’ <code>&quot;quay.io/myapp:v1.0.0&quot;</code></li>
</ol>
<h3 id="patch-processing-engine">Patch Processing Engine</h3>
<h4 id="processing-pipeline">Processing Pipeline</h4>
<ol>
<li><strong>Discovery</strong>: Glob <code>patches/**/*.kpatch</code></li>
<li><strong>Metadata loading</strong>: Load corresponding <code>.yaml</code> files</li>
<li><strong>Dependency resolution</strong>: Build DAG, detect cycles, auto-enable</li>
<li><strong>Conflict checking</strong>: Validate no conflicting patches enabled</li>
<li><strong>Variable substitution</strong>: Replace <code>${...}</code> with resolved values</li>
<li><strong>Patch application</strong>: Apply patches to base resources using Kure engine</li>
<li><strong>Phase organization</strong>: Group resources by install phase</li>
</ol>
<h4 id="dependency-graph-example">Dependency Graph Example</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>10-monitoring.kpatch
â”œâ”€â”€ requires: 05-metrics-base.kpatch
â””â”€â”€ requires: 15-monitoring-rbac.kpatch
    â””â”€â”€ requires: 02-base-rbac.kpatch

Result: Enable 02-base-rbac â†’ 05-metrics-base â†’ 15-monitoring-rbac â†’ 10-monitoring</code></pre></div>
<h3 id="gitops-manifest-generation">GitOps Manifest Generation</h3>
<h4 id="phase-based-organization">Phase-Based Organization</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>output/
â”œâ”€â”€ pre-install/
â”‚   â”œâ”€â”€ kustomization.yaml    # Phase resources only
â”‚   â”œâ”€â”€ namespaces.yaml
â”‚   â”œâ”€â”€ rbac.yaml
â”‚   â””â”€â”€ secrets.yaml
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ kustomization.yaml    # dependsOn: pre-install
â”‚   â”œâ”€â”€ deployments.yaml
â”‚   â””â”€â”€ services.yaml
â””â”€â”€ post-install/
    â”œâ”€â”€ kustomization.yaml    # dependsOn: main  
    â”œâ”€â”€ monitoring.yaml
    â””â”€â”€ backups.yaml</code></pre></div>
<h4 id="kustomization-generation">Kustomization Generation</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># main/kustomization.yaml (auto-generated)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flux dependency</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dependsOn</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-app-pre-install</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">deployments.yaml</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Common labels applied to all resources</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonLabels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">my-app</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app.kubernetes.io/managed-by</span>: <span style="color:#ae81ff">kurel</span></span></span></code></pre></div>
<hr>
<h2 id="future-considerations">Future Considerations</h2>
<h3 id="schema-generation-improvements">Schema Generation Improvements</h3>
<h4 id="enhanced-k8s-api-tracing">Enhanced K8s API Tracing</h4>
<ul>
<li><strong>CRD discovery</strong>: Automatic detection of CRD schemas</li>
<li><strong>Version-aware tracing</strong>: Handle multiple K8s API versions</li>
<li><strong>Complex path resolution</strong>: Better handling of array selectors and wildcards</li>
</ul>
<h4 id="machine-learning-schema-enhancement">Machine Learning Schema Enhancement</h4>
<ul>
<li><strong>Pattern recognition</strong>: Learn common parameter patterns from existing packages</li>
<li><strong>Validation suggestions</strong>: Suggest additional validation rules based on usage</li>
</ul>
<h3 id="package-ecosystem">Package Ecosystem</h3>
<h4 id="package-registry">Package Registry</h4>
<ul>
<li><strong>Distribution</strong>: Central registry for sharing kurel packages</li>
<li><strong>Discovery</strong>: Search and browse available packages</li>
<li><strong>Versioning</strong>: Semantic versioning for packages</li>
<li><strong>Security</strong>: Package signing and verification</li>
</ul>
<h4 id="package-management-tools">Package Management Tools</h4>
<ul>
<li><strong>Installation</strong>: <code>kurel install prometheus-operator</code></li>
<li><strong>Updates</strong>: <code>kurel upgrade --check</code></li>
<li><strong>Dependencies</strong>: Automatic dependency resolution</li>
</ul>
<h3 id="advanced-patch-features">Advanced Patch Features</h3>
<h4 id="patch-testing">Patch Testing</h4>
<ul>
<li><strong>Unit tests</strong>: Test individual patches against known resources</li>
<li><strong>Integration tests</strong>: Test full package generation</li>
<li><strong>Regression tests</strong>: Ensure patches don&rsquo;t break existing functionality</li>
</ul>
<h4 id="patch-composition">Patch Composition</h4>
<ul>
<li><strong>Mixins</strong>: Reusable patch fragments</li>
<li><strong>Inheritance</strong>: Base patches that others extend</li>
<li><strong>Conditional application</strong>: More sophisticated enabling logic</li>
</ul>
<h3 id="developer-experience">Developer Experience</h3>
<h4 id="ide-integration">IDE Integration</h4>
<ul>
<li><strong>Language servers</strong>: Completion and validation in editors</li>
<li><strong>Schema integration</strong>: Real-time parameter validation</li>
<li><strong>Patch debugging</strong>: Visual patch application tracing</li>
</ul>
<h4 id="package-development-tools">Package Development Tools</h4>
<ul>
<li><strong>Scaffolding</strong>: Generate package templates</li>
<li><strong>Validation</strong>: Real-time package structure validation</li>
<li><strong>Testing</strong>: Framework for package testing</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>This comprehensive design represents the result of extensive iteration and consideration of alternatives. The key insight that guided all decisions was the principle that &ldquo;kurel just generates YAML&rdquo; - keeping the system focused on its core purpose while providing powerful customization and validation capabilities.</p>
<p>The design balances several important concerns:</p>
<ul>
<li><strong>Simplicity vs Power</strong>: Provide powerful features without overwhelming complexity</li>
<li><strong>Flexibility vs Validation</strong>: Allow maximum flexibility while catching common errors</li>
<li><strong>Explicitness vs Convenience</strong>: Prefer explicit configuration with convenient defaults</li>
<li><strong>Standards vs Innovation</strong>: Build on existing patterns (Kubernetes, GitOps) while solving real problems</li>
</ul>
<p>The modular patch system, comprehensive parameter handling, and GitOps-native output make kurel well-suited for managing complex Kubernetes applications in a declarative, version-controlled manner. The extensive validation and schema generation capabilities help prevent common configuration errors while maintaining the flexibility that makes Kubernetes powerful.</p>
<p>The decision to reject certain features (package dependencies, complex templating, automatic RBAC) keeps kurel focused on its core competency while allowing the broader ecosystem (GitOps tools, policy engines, package managers) to handle their respective concerns.</p>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<a href="http://localhost:1313/" style="text-decoration: none;">
    <h1 style="margin: 0; padding: 1rem; color: var(--MENU-SECTIONS-ACTIVE-BG-color);">Go Kure</h1>
</a>

<div style="padding: 0 1rem 1rem 1rem;">
    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 0.75rem;">
        <div style="display: flex; align-items: center; font-weight: bold; color: #856404; margin-bottom: 0.25rem; font-size: 0.9rem;">
            <span style="margin-right: 0.5rem;">âš ï¸</span>
            <span>Pre-Release</span>
        </div>
        <div style="font-size: 0.8rem; color: #856404; line-height: 1.3;">
            Unreleased software - APIs subject to change
        </div>
    </div>
</div>
        </div>
        <search><form action="/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/overview/index.html"><a class="padding" href="/overview/index.html">Overview</a></li>
            <li class="" data-nav-id="/getting-started/index.html"><a class="padding" href="/getting-started/index.html">Getting Started</a></li>
            <li class="" data-nav-id="/architecture/index.html"><a class="padding" href="/architecture/index.html">Architecture</a></li>
            <li class="parent " data-nav-id="/packages/index.html"><a class="padding" href="/packages/index.html">Packages</a><ul id="R-subsections-bdf1e8ce92aa8ff6883c617f10480430" class="collapsible-menu">
            <li class="" data-nav-id="/packages/patch/index.html"><a class="padding" href="/packages/patch/index.html">Patch Package</a></li>
            <li class="parent hidden alwaysopen " data-nav-id="/packages/launcher/index.html"><a class="padding" href="/packages/launcher/index.html"></a><ul id="R-subsections-9d3dfa62b00c459cf937434644ffeb15" class="collapsible-menu">
            <li class="active hidden " data-nav-id="/packages/launcher/design-details/index.html"><a class="padding" href="/packages/launcher/design-details/index.html"></a></li></ul></li></ul></li>
            <li class="" data-nav-id="/examples/index.html"><a class="padding" href="/examples/index.html">Examples</a></li>
            <li class="" data-nav-id="/resources/index.html"><a class="padding" href="/resources/index.html">Resources</a></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><div style="position: sticky; bottom: 0; padding: 1rem; margin-top: 2rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-top: 3px solid #ffc107;">
    <div style="display: flex; align-items: center; font-weight: bold; color: #856404; margin-bottom: 0.5rem;">
        <span style="margin-right: 0.5rem;">âš ï¸</span>
        <span>Pre-Release Software</span>
    </div>
    <div style="font-size: 0.875rem; color: #856404; line-height: 1.4;">
        This documentation is for unreleased software. Features and APIs may change before the official release.
    </div>
</div></div>
      </div>
    </aside>
    <script src="/js/clipboard/clipboard.min.js?1754413039" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1754413039" defer></script>
    <script src="/js/theme.js?1754413039" defer></script>
  </body>
</html>
